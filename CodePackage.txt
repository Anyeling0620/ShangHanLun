### TARGET STRUCTURE ###
app\src\main\AndroidManifest.xml
app\src\main\java\com\example\killquestion\KillQuestionApp.kt
app\src\main\java\com\example\killquestion\MainActivity.kt
app\src\main\java\com\example\killquestion\data\local\AnalysisStorage.kt
app\src\main\java\com\example\killquestion\data\local\CustomQuestionStorage.kt
app\src\main\java\com\example\killquestion\data\local\FontManager.kt
app\src\main\java\com\example\killquestion\data\local\Managers.kt
app\src\main\java\com\example\killquestion\data\model\QuestionModels.kt
app\src\main\java\com\example\killquestion\data\remote\AiClient.kt
app\src\main\java\com\example\killquestion\data\remote\AiConfigManager.kt
app\src\main\java\com\example\killquestion\data\remote\UpdateManager.kt
app\src\main\java\com\example\killquestion\data\repository\QuestionRepository.kt
app\src\main\java\com\example\killquestion\ui\components\BusinessComponents.kt
app\src\main\java\com\example\killquestion\ui\components\CommonUi.kt
app\src\main\java\com\example\killquestion\ui\components\MarkdownText.kt
app\src\main\java\com\example\killquestion\ui\dialogs\AppDialogs.kt
app\src\main\java\com\example\killquestion\ui\screens\OnlineSearchScreen.kt
app\src\main\java\com\example\killquestion\ui\screens\QuizScreen.kt
app\src\main\java\com\example\killquestion\ui\screens\SelectionScreen.kt
app\src\main\java\com\example\killquestion\ui\screens\StartScreen.kt
app\src\main\java\com\example\killquestion\ui\screens\WeaknessAnalysisScreen.kt
app\src\main\java\com\example\killquestion\ui\theme\Color.kt
app\src\main\java\com\example\killquestion\ui\theme\Theme.kt
app\src\main\java\com\example\killquestion\ui\theme\Type.kt
app\src\main\java\com\example\killquestion\util\ChineseComparator.kt
app\src\main\java\com\example\killquestion\util\ImageSaver.kt
app\src\main\java\com\example\killquestion\util\PdfExportManager.kt


============================================================
============================================================

### FILE CONTENTS ###

--- FILE: app\src\main\AndroidManifest.xml ---
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.MyApplication">
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/provider_paths" />
        </provider>
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name"
            android:theme="@style/Theme.MyApplication">

            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
```

--- FILE: app\src\main\java\com\example\killquestion\KillQuestionApp.kt ---
```kt
package com.example.killquestion


```

--- FILE: app\src\main\java\com\example\killquestion\MainActivity.kt ---
```kt
package com.example.killquestion

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.BackHandler
import androidx.activity.compose.setContent
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.systemBarsPadding
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import com.example.killquestion.data.local.MistakeManager
import com.example.killquestion.data.local.ProgressManager
import com.example.killquestion.data.model.QuizContext
import com.example.killquestion.data.remote.AiConfigManager
import com.example.killquestion.data.remote.SimpleAiClient
import com.example.killquestion.data.repository.QuestionRepository
import com.example.killquestion.ui.components.AnimatedBackground
import com.example.killquestion.ui.screens.QuizScreen
import com.example.killquestion.ui.screens.SelectionScreen
import com.example.killquestion.ui.screens.StartScreen
import com.example.killquestion.ui.screens.WeaknessAnalysisScreen // [新增引用]
import com.example.killquestion.ui.theme.*
import kotlinx.coroutines.launch
import com.example.killquestion.data.local.AnalysisStorage
import com.example.killquestion.data.local.CustomQuestionStorage
import com.example.killquestion.ui.screens.OnlineSearchScreen
import com.example.killquestion.data.local.FontManager

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        ProgressManager.init(this)
        MistakeManager.init(this)
        AiConfigManager.init(this)
        AnalysisStorage.init(this)
        CustomQuestionStorage.init(this)
        FontManager.init(this)
        // [新增]：每次启动App，自动在后台检查并下载缺少的字体
        FontManager.startBackgroundDownload()

        setContent {
            MaterialTheme(
                colorScheme = lightColorScheme(
                    primary = ZenGreenPrimary,
                    background = ZenBackgroundStart,
                    surface = ZenSurface,
                    onSurface = TextPrimary
                )
            ) {
                AppNavigation()
            }
        }
    }
}

@Composable
fun AppNavigation() {
    val context = LocalContext.current
    var currentScreen by remember { mutableStateOf("START") }
    var quizContext by remember { mutableStateOf<QuizContext?>(null) }

    // [新增] 提升弱点分析的状态到这里，确保切换页面不丢失
    var weaknessCards by remember { mutableStateOf(AnalysisStorage.getCards()) }
    var isWeaknessAnalyzing by remember { mutableStateOf(false) }
    val scope = rememberCoroutineScope()

    LaunchedEffect(Unit) {
        QuestionRepository.load(context)
    }

    // 处理返回键
    BackHandler(enabled = currentScreen != "START") {
        when (currentScreen) {
            "QUIZ" -> currentScreen = if (quizContext?.isMistakeMode == true) "START" else quizContext?.sourceScreen ?: "START"
            "SELECTION_CHAPTER", "SELECTION_TYPE", "WEAKNESS_ANALYSIS", "ONLINE_SEARCH" -> currentScreen = "START" // [修改]
            else -> { }
        }
    }

    fun triggerWeaknessAnalysis(forceRefresh: Boolean = false) {
        // 如果不强制刷新，且内存有数据，直接跳
        if (!forceRefresh && weaknessCards.isNotEmpty()) {
            currentScreen = "WEAKNESS_ANALYSIS"
            return
        }

        // 如果强制刷新，或者内存没数据但本地有数据(且没选强制刷新)，这里其实已经被上面的初始化覆盖了
        // 所以这里主要处理“强制刷新”或“完全无数据”的情况

        currentScreen = "WEAKNESS_ANALYSIS"
        isWeaknessAnalyzing = true

        scope.launch {
            val mistakes = QuestionRepository.getMistakeQuestions()
            val result = SimpleAiClient.analyzeWeakness(mistakes)

            // [新增]：AI 返回结果后，保存到本地
            AnalysisStorage.saveCards(result)

            weaknessCards = result
            isWeaknessAnalyzing = false
        }
    }

    Box(modifier = Modifier.fillMaxSize()) {
        AnimatedBackground()

        // 注意：WeaknessAnalysisScreen 也是全屏的，不需要 systemBarsPadding (它内部处理了)
        // 但其他页面需要。
        Box(modifier = Modifier.fillMaxSize()) {
            when (currentScreen) {
                "START" -> {
                    // 给 StartScreen 加 padding
                    Box(modifier = Modifier.systemBarsPadding()) {
                        StartScreen(
                            onModeSelect = { mode ->
                                when (mode) {
                                    "CHAPTER" -> currentScreen = "SELECTION_CHAPTER"
                                    "TYPE" -> currentScreen = "SELECTION_TYPE"
                                    "ONLINE" -> currentScreen = "ONLINE_SEARCH"
                                    "MISTAKE" -> {
                                        val mistakes = QuestionRepository.getMistakeQuestions()
                                        if (mistakes.isNotEmpty()) {
                                            quizContext = QuizContext("错题本", mistakes, isMistakeMode = true, sourceScreen = "START")
                                            currentScreen = "QUIZ"
                                        }
                                    }
                                }
                            },
                            // [新增] 传入跳转回调
                            onWeaknessAnalysisClick = {
                                triggerWeaknessAnalysis(forceRefresh = false)
                            }
                        )
                    }
                }
                "SELECTION_CHAPTER" -> Box(modifier = Modifier.systemBarsPadding()) {
                    SelectionScreen(
                        title = "章节选择",
                        subtitle = "系统复习 · 循序渐进",
                        items = QuestionRepository.chapterList,
                        onBack = { currentScreen = "START" },
                        onSelect = { chapter ->
                            val qs = QuestionRepository.getQuestionsByChapter(chapter)
                            quizContext = QuizContext(chapter, qs, sourceScreen = "SELECTION_CHAPTER")
                            currentScreen = "QUIZ"
                        }
                    )
                }
                "SELECTION_TYPE" -> Box(modifier = Modifier.systemBarsPadding()) {
                    SelectionScreen(
                        title = "题型专练",
                        subtitle = "专项突破 · 查漏补缺",
                        // [关键修复]：这里传入 items 时，手动合并 题型列表 + 联网章节列表
                        // 这样 SelectionScreen 才能从 list 里分离出 onlineItems 并显示
                        items = QuestionRepository.categoryList +
                                QuestionRepository.chapterList.filter { it.startsWith("联网搜索") },

                        onBack = { currentScreen = "START" },
                        onSelect = { selectedItem ->
                            // ... 之前的逻辑 (判断 startsWith 联网搜索) 保持不变 ...
                            if (selectedItem.startsWith("联网搜索")) {
                                val qs = QuestionRepository.getQuestionsByChapter(selectedItem)
                                quizContext = QuizContext(selectedItem.removePrefix("联网搜索:"), qs, sourceScreen = "SELECTION_TYPE")
                            } else {
                                val qs = QuestionRepository.getQuestionsByCategory(selectedItem)
                                quizContext = QuizContext(selectedItem, qs, sourceScreen = "SELECTION_TYPE")
                            }
                            currentScreen = "QUIZ"
                        }
                    )
                }
                "ONLINE_SEARCH" -> Box(modifier = Modifier.systemBarsPadding()) {
                    OnlineSearchScreen(
                        onBack = { currentScreen = "START" },
                        onQuizStart = { title, questions ->
                            quizContext = QuizContext(title, questions, sourceScreen = "ONLINE_SEARCH")
                            currentScreen = "QUIZ"
                        }
                    )
                }
                "QUIZ" -> Box(modifier = Modifier.systemBarsPadding()) {
                    quizContext?.let { ctx ->
                        QuizScreen(
                            context = ctx,
                            onBack = {
                                currentScreen = if (ctx.isMistakeMode) "START" else ctx.sourceScreen
                            }
                        )
                    }
                }
                // [新增] 弱点分析页面 (新页面自己处理了padding，所以外面不包)
                "WEAKNESS_ANALYSIS" -> {
                    WeaknessAnalysisScreen(
                        cards = weaknessCards,
                        isLoading = isWeaknessAnalyzing,
                        onBack = { currentScreen = "START" },
                        onRefresh = { triggerWeaknessAnalysis(forceRefresh = true) }
                    )
                }
            }
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\local\AnalysisStorage.kt ---
```kt
package com.example.killquestion.data.local

import android.content.Context
import android.content.SharedPreferences
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

object AnalysisStorage {
    private const val PREF_NAME = "analysis_storage"
    private const val KEY_CARDS = "weakness_cards"
    private lateinit var prefs: SharedPreferences
    private val gson = Gson()

    fun init(context: Context) {
        prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
    }

    // 保存卡片数据
    fun saveCards(cards: List<Pair<String, String>>) {
        val json = gson.toJson(cards)
        prefs.edit().putString(KEY_CARDS, json).apply()
    }

    // 读取卡片数据
    fun getCards(): List<Pair<String, String>> {
        val json = prefs.getString(KEY_CARDS, null) ?: return emptyList()
        val type = object : TypeToken<List<Pair<String, String>>>() {}.type
        return try {
            gson.fromJson(json, type)
        } catch (e: Exception) {
            emptyList()
        }
    }

    // 检查是否有缓存
    fun hasData(): Boolean = prefs.contains(KEY_CARDS)
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\local\CustomQuestionStorage.kt ---
```kt
package com.example.killquestion.data.local

import android.content.Context
import android.content.SharedPreferences
import com.example.killquestion.data.model.Question
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken

object CustomQuestionStorage {
    private const val PREF_NAME = "custom_questions_db"
    private const val KEY_QUESTIONS = "saved_questions"
    private lateinit var prefs: SharedPreferences
    private val gson = Gson()

    // 内存缓存，减少IO
    private val memoryCache = mutableListOf<Question>()

    fun init(context: Context) {
        prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE)
        loadFromDisk()
    }

    private fun loadFromDisk() {
        val json = prefs.getString(KEY_QUESTIONS, null)
        if (json != null) {
            val type = object : TypeToken<List<Question>>() {}.type
            val list: List<Question> = gson.fromJson(json, type)
            memoryCache.clear()
            memoryCache.addAll(list)
        }
    }

    fun saveQuestions(newQuestions: List<Question>) {
        // 去重添加
        val existingIds = memoryCache.map { it.id }.toSet()
        val toAdd = newQuestions.filter { it.id !in existingIds }

        if (toAdd.isNotEmpty()) {
            memoryCache.addAll(toAdd)
            val json = gson.toJson(memoryCache)
            prefs.edit().putString(KEY_QUESTIONS, json).apply()
        }
    }

    // [新增] 删除指定章节的所有题目
    fun deleteQuestionsByChapter(chapterName: String) {
        // 过滤掉要删除的章节
        val filtered = memoryCache.filter { it.chapter != chapterName }

        // 更新内存
        memoryCache.clear()
        memoryCache.addAll(filtered)

        // 更新本地文件
        val json = gson.toJson(memoryCache)
        prefs.edit().putString(KEY_QUESTIONS, json).apply()
    }

    fun getAll(): List<Question> {
        return memoryCache
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\local\FontManager.kt ---
```kt
package com.example.killquestion.data.local

import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.content.SharedPreferences
import android.graphics.Typeface
import android.os.Build
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import androidx.compose.ui.text.font.FontFamily
import androidx.core.app.NotificationCompat
import androidx.core.app.NotificationManagerCompat
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import java.net.HttpURLConnection
import java.net.URL
import java.security.SecureRandom
import java.security.cert.X509Certificate
import javax.net.ssl.HttpsURLConnection
import javax.net.ssl.SSLContext
import javax.net.ssl.TrustManager
import javax.net.ssl.X509TrustManager

// 1. 定义数据类 (放在 object 外部)
data class FontConfig(
    val code: String,
    val name: String,
    val fileName: String,
    val url: String
)

// 2. 定义单例对象 (确保文件中只有一个 object FontManager)
object FontManager {
    private const val PREF_FONT = "app_font_pref"
    private const val KEY_CURRENT_FONT = "current_font_key"
    private const val CHANNEL_ID = "font_download_channel"
    private const val NOTIFICATION_ID = 1001

    private lateinit var prefs: SharedPreferences
    private lateinit var appContext: Context

    // 基础 URL
    private const val BASE_URL = "https://xn--r7qu00bb2c.top/font"

    // 字体列表配置
    val fontList = listOf(
        FontConfig("SYSTEM", "系统默认", "", ""),
        FontConfig("YAHEI", "微软雅黑", "msyh.ttf", "https://111.228.58.72:41347/down/XscBKv1akCLx.ttf"),
        FontConfig("WK_REGULAR", "文楷-标准", "LXGWWenKai-Regular.ttf", "https://111.228.58.72:41347/down/9CbvERNEb3zs.ttf"),
        FontConfig("WK_MONO_REG", "文楷等宽-标准", "LXGWWenKaiMono-Regular.ttf", "https://111.228.58.72:41347/down/wIQMhPiwK5QR.ttf"),
        FontConfig("WK_MEDIUM", "文楷-中粗", "LXGWWenKai-Medium.ttf", "https://111.228.58.72:41347/down/dAAlXzwIpeb1.ttf"),
        FontConfig("WK_MONO_MED", "文楷等宽-中粗", "LXGWWenKaiMono-Medium.ttf", "https://111.228.58.72:41347/down/VUkgerewRaQN.ttf"),
        FontConfig("WK_LIGHT", "文楷-细体", "LXGWWenKai-Light.ttf", "https://111.228.58.72:41347/down/hq1M3lhmLKja.ttf"),
        FontConfig("WK_MONO_LGT", "文楷等宽-细体", "LXGWWenKaiMono-Light.ttf", "https://111.228.58.72:41347/down/9CbvERNEb3zs.ttf")
    )

    var currentFontFamily by mutableStateOf<FontFamily>(FontFamily.Default)
    var currentFontName by mutableStateOf("系统默认")

    // 下载状态管理
    var downloadingStates = mutableMapOf<String, Boolean>()
    var isBackgroundDownloading by mutableStateOf(false)

    // 初始化方法
    fun init(context: Context) {
        appContext = context.applicationContext
        prefs = context.getSharedPreferences(PREF_FONT, Context.MODE_PRIVATE)

        createNotificationChannel() // 初始化通知渠道

        val savedFontCode = prefs.getString(KEY_CURRENT_FONT, "SYSTEM") ?: "SYSTEM"
        if (isFontDownloaded(savedFontCode)) {
            applyFont(savedFontCode)
        } else {
            applyFont("SYSTEM")
        }
    }

    // 创建通知渠道 (Android 8.0+)
    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val name = "资源下载"
            val descriptionText = "显示字体下载进度"
            val importance = NotificationManager.IMPORTANCE_LOW
            val channel = NotificationChannel(CHANNEL_ID, name, importance).apply {
                description = descriptionText
            }
            val notificationManager: NotificationManager =
                appContext.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
            notificationManager.createNotificationChannel(channel)
        }
    }

    // 启动后台静默下载 (不带回调)
    fun startBackgroundDownload() {
        isBackgroundDownloading = true
        CoroutineScope(Dispatchers.IO).launch {
            fontList.forEach { config ->
                if (config.code != "SYSTEM" && !isFontDownloaded(config.code)) {
                    // 调用下面的 downloadFont，传入空的回调
                    downloadFont(config.code) { }
                }
            }
            isBackgroundDownloading = false
        }
    }

    // 检查是否已下载
    fun isFontDownloaded(fontCode: String): Boolean {
        if (fontCode == "SYSTEM") return true
        val config = fontList.find { it.code == fontCode } ?: return false
        val file = File(appContext.filesDir, "fonts/${config.fileName}")
        return file.exists() && file.length() > 10240
    }

    // 切换字体
    fun switchFont(fontCode: String) {
        if (isFontDownloaded(fontCode)) {
            prefs.edit().putString(KEY_CURRENT_FONT, fontCode).apply()
            applyFont(fontCode)
        }
    }

    // [核心] 下载字体 (带进度回调)
    // [核心] 下载字体 (带进度回调 + 忽略SSL校验)
    suspend fun downloadFont(fontCode: String, onProgress: (Float) -> Unit): Boolean {
        val config = fontList.find { it.code == fontCode } ?: return false
        if (config.url.isEmpty()) return false

        withContext(Dispatchers.Main) { downloadingStates[fontCode] = true }

        // 准备通知
        val notifyManager = NotificationManagerCompat.from(appContext)
        val builder = NotificationCompat.Builder(appContext, CHANNEL_ID)
            .setSmallIcon(android.R.drawable.stat_sys_download)
            .setContentTitle("正在下载: ${config.name}")
            .setPriority(NotificationCompat.PRIORITY_LOW)
            .setOngoing(true)
            .setProgress(100, 0, false)

        try { notifyManager.notify(NOTIFICATION_ID, builder.build()) } catch (e: SecurityException) {}

        return withContext(Dispatchers.IO) {
            var success = false
            try {
                val url = URL(config.url)
                val connection = url.openConnection() as HttpURLConnection

                // ▼▼▼▼▼▼ 核心修改区域 ▼▼▼▼▼▼
                // 如果是 HTTPS，强制信任所有证书
                if (connection is HttpsURLConnection) {
                    // 1. 创建一个信任所有证书的 TrustManager
                    val trustAllCerts = arrayOf<TrustManager>(object : X509TrustManager {
                        override fun getAcceptedIssuers(): Array<X509Certificate> = arrayOf()
                        override fun checkClientTrusted(certs: Array<X509Certificate>, authType: String) {}
                        override fun checkServerTrusted(certs: Array<X509Certificate>, authType: String) {}
                    })

                    // 2. 初始化 SSLContext
                    val sc = SSLContext.getInstance("SSL")
                    sc.init(null, trustAllCerts, SecureRandom())

                    // 3. 应用 SocketFactory (注意这里全是小写 ssl)
                    connection.sslSocketFactory = sc.socketFactory

                    // 4. 忽略主机名校验 (允许 IP 直连)
                    connection.hostnameVerifier = javax.net.ssl.HostnameVerifier { _, _ -> true }
                }
                // ▲▲▲▲▲▲ 修改结束 ▲▲▲▲▲▲

                connection.connectTimeout = 15000
                connection.readTimeout = 15000
                connection.connect()

                if (connection.responseCode == HttpURLConnection.HTTP_OK) {
                    val fileLength = connection.contentLength
                    val inputStream = connection.inputStream

                    val fontDir = File(appContext.filesDir, "fonts")
                    if (!fontDir.exists()) fontDir.mkdirs()

                    val tmpFile = File(fontDir, "${config.fileName}.tmp")
                    val finalFile = File(fontDir, config.fileName)

                    val outputStream = FileOutputStream(tmpFile)
                    val data = ByteArray(4096)
                    var total: Long = 0
                    var count: Int
                    var lastNotifyTime = 0L

                    while (inputStream.read(data).also { count = it } != -1) {
                        total += count
                        outputStream.write(data, 0, count)

                        if (fileLength > 0) {
                            val progress = total.toFloat() / fileLength
                            onProgress(progress)

                            val now = System.currentTimeMillis()
                            if (now - lastNotifyTime > 500) {
                                builder.setProgress(100, (progress * 100).toInt(), false)
                                    .setContentText("${(progress * 100).toInt()}%")
                                try { notifyManager.notify(NOTIFICATION_ID, builder.build()) } catch (e: SecurityException) {}
                                lastNotifyTime = now
                            }
                        }
                    }

                    outputStream.close()
                    inputStream.close()

                    if (tmpFile.renameTo(finalFile)) {
                        success = true
                    }
                } else {
                    // 错误提示
                    withContext(Dispatchers.Main) {
                        android.widget.Toast.makeText(appContext, "下载失败: ${connection.responseCode}", android.widget.Toast.LENGTH_LONG).show()
                    }
                }
            } catch (e: Exception) {
                e.printStackTrace()
                success = false
                withContext(Dispatchers.Main) {
                    android.widget.Toast.makeText(appContext, "出错: ${e.localizedMessage}", android.widget.Toast.LENGTH_LONG).show()
                }
            } finally {
                withContext(Dispatchers.Main) { downloadingStates[fontCode] = false }
                try { notifyManager.cancel(NOTIFICATION_ID) } catch (e: SecurityException) {}
            }
            success
        }
    }

    // 应用字体到 Compose
    private fun applyFont(fontCode: String) {
        val config = fontList.find { it.code == fontCode }

        if (config == null || fontCode == "SYSTEM") {
            currentFontFamily = FontFamily.Default
            currentFontName = "系统默认"
            return
        }

        try {
            val file = File(appContext.filesDir, "fonts/${config.fileName}")
            if (file.exists()) {
                val typeface = Typeface.createFromFile(file)
                currentFontFamily = FontFamily(typeface)
                currentFontName = config.name
            } else {
                currentFontFamily = FontFamily.Default
                currentFontName = "系统默认 (未下载)"
            }
        } catch (e: Exception) {
            e.printStackTrace()
            currentFontFamily = FontFamily.Default
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\local\Managers.kt ---
```kt
package com.example.killquestion.data.local

import android.content.Context
import android.content.SharedPreferences
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue

object ProgressManager {
    private const val PREF_PROGRESS = "quiz_progress_v3"
    private lateinit var prefs: SharedPreferences

    fun init(context: Context) {
        prefs = context.getSharedPreferences(PREF_PROGRESS, Context.MODE_PRIVATE)
    }

    fun markCompleted(questionId: String) {
        prefs.edit().putBoolean(questionId, true).apply()
    }

    fun isCompleted(questionId: String): Boolean {
        return prefs.getBoolean(questionId, false)
    }

    // [新增] 批量移除进度 (用于删除题库时联动清理)
    fun removeRecords(questionIds: List<String>) {
        val editor = prefs.edit()
        var changed = false
        questionIds.forEach { id ->
            if (prefs.contains(id)) {
                editor.remove(id)
                changed = true
            }
        }
        if (changed) {
            editor.apply()
        }
    }
}

object MistakeManager {
    private const val PREF_MISTAKES = "quiz_mistakes_v3"
    private lateinit var prefs: SharedPreferences

    // UI 监听这个变量来刷新
    var mistakeChangeTrigger by mutableStateOf(0L)

    fun init(context: Context) {
        prefs = context.getSharedPreferences(PREF_MISTAKES, Context.MODE_PRIVATE)
    }

    fun addMistake(questionId: String) {
        prefs.edit().putBoolean(questionId, true).apply()
        mistakeChangeTrigger = System.currentTimeMillis()
    }

    fun removeMistake(questionId: String) {
        if (isMistake(questionId)) {
            prefs.edit().remove(questionId).apply()
            mistakeChangeTrigger = System.currentTimeMillis()
        }
    }

    // [新增] 批量移除错题 (用于删除题库时联动清理)
    fun removeMistakes(questionIds: List<String>) {
        val editor = prefs.edit()
        var changed = false
        questionIds.forEach { id ->
            if (prefs.contains(id)) {
                editor.remove(id)
                changed = true
            }
        }
        if (changed) {
            editor.apply()
            // 触发 UI 刷新
            mistakeChangeTrigger = System.currentTimeMillis()
        }
    }

    fun toggleMistake(questionId: String) {
        if (isMistake(questionId)) {
            removeMistake(questionId)
        } else {
            addMistake(questionId)
        }
    }

    fun isMistake(questionId: String): Boolean {
        return prefs.contains(questionId)
    }

    fun getAllMistakeIds(): Set<String> {
        return prefs.all.keys
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\model\QuestionModels.kt ---
```kt
package com.example.killquestion.data.model

import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.List
import androidx.compose.material.icons.filled.CheckCircle
import androidx.compose.material.icons.filled.Edit
import androidx.compose.material.icons.filled.Face
import androidx.compose.material.icons.filled.ThumbUp
import androidx.compose.ui.graphics.vector.ImageVector

data class QuestionWrapper(
    val version: String,
    val source: String,
    val total_count: Int,
    val data: List<Question>
)

data class Option(
    val label: String,
    val text: String
)

data class Question(
    val id: String,
    val number: Int,
    val chapter: String,
    val category: String,
    val type: String,
    val content: String,
    val options: List<Option> = emptyList(),
    val answer: String,
    val analysis: String
) {
    fun getUiType(): QuestionType {
        return try {
            QuestionType.valueOf(type)
        } catch (e: Exception) {
            QuestionType.ESSAY
        }
    }

    fun getRealAnswer(): String {
        val typeEnum = getUiType()
        if (typeEnum == QuestionType.TRUE_FALSE) {
            if (answer.contains("正确") && !answer.contains("不正确")) return "A"
            if (answer.contains("对") && !answer.contains("不对")) return "A"
            if (answer.contains("不正确") || answer.contains("错误") || answer.contains("错")) return "B"
            val clean = answer.trim().uppercase()
            if (clean == "A" || clean == "T" || clean == "TRUE") return "A"
            if (clean == "B" || clean == "F" || clean == "FALSE") return "B"
            return "A"
        }
        val cleaned = answer.uppercase().filter { it in 'A'..'E' }
        return if (cleaned.isNotEmpty()) cleaned else answer
    }

    fun getFullExplanation(): String {
        if (getUiType() == QuestionType.TRUE_FALSE) {
            var cleanAns = answer.replace(Regex("答案|参考答案|正确答案|：|:"), "")
            cleanAns = cleanAns.replace(Regex("不正确|正确|错误|对|错|A|B|T|F|TRUE|FALSE", RegexOption.IGNORE_CASE), "")
            cleanAns = cleanAns.trim().trimStart('。', '，', '.', ',')
            val parts = listOf(cleanAns, analysis).filter { it.isNotBlank() }
            return if (parts.isEmpty()) "暂无详细解析" else parts.joinToString("\n\n")
        }
        return analysis.ifBlank { "暂无详细解析" }
    }
}

enum class QuestionType(val icon: ImageVector) {
    SINGLE_CHOICE(Icons.Default.CheckCircle),
    MULTI_CHOICE(Icons.AutoMirrored.Filled.List),
    TRUE_FALSE(Icons.Default.ThumbUp),
    FILL_BLANK(Icons.Default.Edit),
    ESSAY(Icons.Default.Face)
}

data class QuizContext(
    val title: String,
    val questions: List<Question>,
    val isMistakeMode: Boolean = false,
    val sourceScreen: String = "START"
)
```

--- FILE: app\src\main\java\com\example\killquestion\data\remote\AiClient.kt ---
```kt
package com.example.killquestion.data.remote

import com.example.killquestion.data.model.Option
import com.example.killquestion.data.model.Question
import com.google.gson.Gson
import com.google.gson.reflect.TypeToken
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import kotlinx.coroutines.flow.flowOn
import java.io.BufferedReader
import java.net.HttpURLConnection
import java.net.InetSocketAddress
import java.net.Proxy
import java.net.SocketTimeoutException
import java.net.URL
import java.net.UnknownHostException
import java.util.concurrent.atomic.AtomicInteger

object SimpleAiClient {
    private val gson = Gson()
    // 用于轮询 Key 的索引
    private val keyIndex = AtomicInteger(0)

    // 获取下一个 Key (轮询策略)
    private fun getNextKey(): String {
        val keys = AiConfigManager.getKeyList()
        if (keys.isEmpty()) return ""
        // 简单的轮询：每次调用索引+1，取模
        val index = keyIndex.getAndIncrement() % keys.size
        return keys[index]
    }

    // [核心] 通用请求方法：返回 Flow<String> 实现流式
    // isStreaming: 是否开启流式模式 (true: 逐字返回, false: 一次性返回)
    private fun sendRequestStream(prompt: String, isStreaming: Boolean): Flow<String> = flow {
        val currentKey = getNextKey()
        if (currentKey.isBlank()) {
            emit("❌ 错误：未配置 API Key，请在设置中添加。")
            return@flow
        }

        var connection: HttpURLConnection? = null
        try {
            val url = URL(AiConfigManager.baseUrl)

            // [特性3] 配置代理
            connection = if (AiConfigManager.enableProxy) {
                val port = AiConfigManager.proxyPort.toIntOrNull() ?: 7890
                val proxy = Proxy(Proxy.Type.HTTP, InetSocketAddress(AiConfigManager.proxyHost, port))
                url.openConnection(proxy) as HttpURLConnection
            } else {
                url.openConnection() as HttpURLConnection
            }

            connection.requestMethod = "POST"
            connection.setRequestProperty("Content-Type", "application/json; charset=utf-8")
            connection.setRequestProperty("Authorization", "Bearer $currentKey")
            connection.setRequestProperty("HTTP-Referer", "https://github.com/YourApp")
            connection.setRequestProperty("X-Title", "ShangHanLun Quiz")
            connection.connectTimeout = 15000 // 15秒连接超时
            connection.readTimeout = 60000    // 60秒读取超时
            connection.doOutput = true

            // [特性4] 开启 stream: true
            val payloadMap = mapOf(
                "model" to AiConfigManager.model,
                "messages" to listOf(mapOf("role" to "user", "content" to prompt)),
                "stream" to isStreaming // 动态决定是否流式
            )
            val jsonBody = gson.toJson(payloadMap)

            connection.outputStream.use { os -> os.write(jsonBody.toByteArray(Charsets.UTF_8)) }

            val responseCode = connection.responseCode
            if (responseCode == 200) {
                val inputStream = connection.inputStream
                val reader = BufferedReader(inputStream.reader())

                if (isStreaming) {
                    // --- 流式处理 ---
                    var line: String?
                    while (reader.readLine().also { line = it } != null) {
                        val dataLine = line?.trim() ?: continue
                        if (dataLine.startsWith("data:")) {
                            val jsonStr = dataLine.removePrefix("data:").trim()
                            if (jsonStr == "[DONE]") break

                            try {
                                // 解析流式 JSON: {"choices":[{"delta":{"content":"..."}}]}
                                val chunkObj = gson.fromJson(jsonStr, Map::class.java)
                                val choices = chunkObj["choices"] as? List<*>
                                val delta = (choices?.get(0) as? Map<*, *>)?.get("delta") as? Map<*, *>
                                val content = delta?.get("content") as? String

                                if (!content.isNullOrEmpty()) {
                                    emit(content) // 发射每一个字
                                }
                            } catch (e: Exception) {
                                // 忽略解析错误的行
                            }
                        }
                    }
                } else {
                    // --- 非流式处理 (用于搜题生成JSON) ---
                    val responseText = reader.readText()
                    val responseObj = gson.fromJson(responseText, Map::class.java)
                    val choices = responseObj["choices"] as? List<*>
                    val message = (choices?.get(0) as? Map<*, *>)?.get("message") as? Map<*, *>
                    val content = message?.get("content") as? String ?: ""
                    emit(content)
                }
            } else {
                // [特性1] 详细错误处理
                val errorText = connection.errorStream?.bufferedReader()?.use { it.readText() } ?: "无详细信息"
                val errorMsg = when (responseCode) {
                    401 -> "❌ 认证失败 (401)：API Key 无效或过期。"
                    403 -> "❌ 拒绝访问 (403)：该地区被禁止或账号异常。"
                    429 -> "❌ 请求过多 (429)：达到速率限制，正在尝试切换 Key..." // 这里未来可以做自动重试
                    500, 502, 503 -> "❌ 服务器错误 ($responseCode)：AI 服务商暂时不可用。"
                    else -> "❌ 请求失败 ($responseCode)：$errorText"
                }
                emit(errorMsg)
            }

        } catch (e: Exception) {
            // [特性1] 网络异常详细分类
            val errorMsg = when (e) {
                is UnknownHostException -> "❌ 网络错误：找不到服务器，请检查网络或代理设置。"
                is SocketTimeoutException -> "❌ 连接超时：AI 响应太慢，请检查网络。"
                else -> "❌ 未知错误：${e.localizedMessage}"
            }
            emit(errorMsg)
        } finally {
            connection?.disconnect()
        }
    }.flowOn(Dispatchers.IO)

    // 1. 问答/解析 (使用流式)
    fun askAiStream(question: String, answer: String, fullAnalysis: String): Flow<String> {
        val prompt = """
            你是一位中医专家。
            题目：$question
            参考答案：$answer
            
            请解析这道题：
            1. 核心考点。
            2. 为什么选该答案。
            3. 排除干扰项（如果是选择题）。
            
            要求：Markdown格式，精练，200字以内。
        """.trimIndent()
        return sendRequestStream(prompt, true)
    }

    // 2. 弱点分析 (使用流式)
    suspend fun analyzeWeakness(mistakeQuestions: List<Question>): List<Pair<String, String>> {
        if (mistakeQuestions.isEmpty()) return listOf("暂无错题" to "快去刷题吧！")
        val sampleQuestions = mistakeQuestions.takeLast(15)
        val questionsText = sampleQuestions.mapIndexed { i, q -> "${i+1}. [${q.category}] ${q.content}" }.joinToString("\n")

        val prompt = """
            你是一位中医考研辅导专家。以下是学生最近做错的题目：
            
            $questionsText
            
            请为这些错题制作【复习知识卡片】。
            
            【数量与策略】：
            1. **不要**进行笼统的概括。
            2. 请尽量为**每一个**具体的知识点/汤证/病机生成一张独立的卡片。
            3. 如果多道题考的是同一个汤证（如都是桂枝汤），请合并为一张深度解析卡片。
            4. 目标是生成尽可能详细的复习资料，卡片数量根据题目实际考点数量决定（不设上限）。

            【卡片内容要求】：
            必须包含以下分点（使用 Markdown 列表）：
            - **易错点**：指出为什么容易做错。
            - **核心考点详解**：深度剖析该方剂或条文。
            - **辨证眼目/口诀**：辅助记忆的关键词。

            【格式严格要求】：
            1. 格式：知识点标题#知识点内容
            2. 每张卡片之间用 "|||" 分隔。
            3. 标题纯文本，内容使用 Markdown。
        """.trimIndent()

        // 收集 Flow 结果拼接成字符串
        val sb = StringBuilder()
        sendRequestStream(prompt, false).collect { sb.append(it) }
        val content = sb.toString()

        if (content.startsWith("❌")) {
            return listOf("分析失败" to content)
        }

        return content.split("|||").mapNotNull {
            val parts = it.trim().split("#")
            if (parts.size >= 2) parts[0].trim() to parts[1].trim() else null
        }.ifEmpty { listOf("分析完成" to content) }
    }

    // 3. 联网搜题 (必须非流式)
    suspend fun generateOnlineQuestions(keyword: String, count: Int): List<Question> {
        val prompt = """
            请根据关键词【$keyword】，生成 $count 道中医（伤寒论课程）题目。
            
            【题型混合要求】：
            请按适合该知识点的形式，混合以下题型（不要局限于选择题）：
            1. **A1/A2型题** (单选) -> type: "SINGLE_CHOICE"
            2. **X型题** (多选) -> type: "MULTI_CHOICE"
            3. **判断说明题** -> type: "TRUE_FALSE" (选项放 A:正确, B:错误)
            4. **填空题** -> type: "FILL_BLANK" (options留空)
            5. **名词解释题/简答题/论述题/病例分析题** -> type: "ESSAY" (options留空)
            
            【JSON 格式要求】：
            必须返回严格的 JSON 数组，JSON 结构如下：
            [
              {
                "type": "SINGLE_CHOICE",
                "category": "A1型题",
                "content": "题目内容",
                "options": [
                  {"label": "A", "text": "选项内容"}
                ],
                "answer": "A",
                "analysis": "解析内容"
              }
            ]
            
            【内容要求】：
            1. 难度适中，符合中医执业医师/考研标准。
            2. 确保 JSON 格式合法，不要包含 ```json 等标记。
            3. 题目数量尽量接近 $count 道。
        """.trimIndent()

        val sb = StringBuilder()
        sendRequestStream(prompt, false).collect { sb.append(it) }
        val jsonStr = sb.toString()

        if (jsonStr.startsWith("❌")) return emptyList()

        val cleanJson = jsonStr.replace("```json", "").replace("```", "").trim()

        return try {
            val type = object : TypeToken<List<Map<String, Any>>>() {}.type
            val rawList: List<Map<String, Any>> = gson.fromJson(cleanJson, type)
            rawList.mapIndexed { index, map ->
                val rawOptions = map["options"] as? List<Map<String, String>> ?: emptyList()
                val options = rawOptions.map { Option(it["label"] ?: "", it["text"] ?: "") }
                Question(
                    id = "online_${System.currentTimeMillis()}_$index",
                    number = 0,
                    chapter = "联网搜索: $keyword",
                    category = map["category"] as? String ?: "综合题",
                    type = map["type"] as? String ?: "ESSAY",
                    content = map["content"] as? String ?: "加载失败",
                    options = options,
                    answer = map["answer"] as? String ?: "略",
                    analysis = map["analysis"] as? String ?: "暂无"
                )
            }
        } catch (e: Exception) {
            e.printStackTrace()
            emptyList()
        }
    }
    // [新增] 4. AI 绘图 (生成 Pollinations 图片链接)
    fun generateImageCreation(userDescription: String): Flow<String> {
        val modelName = AiConfigManager.model
        // 构建你要求的 Prompt
        val prompt = """
            你好 $modelName，现在你的角色是AI图片生成机器人。
            
            用户给出的中文关键词描述是：【$userDescription】
            
            请你执行以下步骤：
            1. 理解用户的描述，进行艺术加工、润色，丰富光影、细节、风格等描述（不要偏离原意）。
            2. 将润色后的描述翻译成英文 Prompt。
            3. 将英文 Prompt 经过 URL 编码 (例如空格转为 %20) 后，填充到下方链接的 {prompt} 处。
            
            请直接输出一张 Markdown 图片，格式如下（不要输出其他废话）：
            ![AI Image](https://image.pollinations.ai/prompt/{prompt}?width=1024&height=1024&enhance=true&private=true&nologo=true&safe=true&model=flux)
        """.trimIndent()

        // 使用流式请求，虽然只要一个链接，但保持统一
        return sendRequestStream(prompt, true)
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\remote\AiConfigManager.kt ---
```kt
package com.example.killquestion.data.remote

import android.content.Context
import android.content.SharedPreferences
import com.example.killquestion.data.remote.AiConfigManager.apiKeys

object AiConfigManager {
    private const val PREF_AI = "quiz_ai_config"
    private lateinit var prefs: SharedPreferences

    private const val DEFAULT_BASE_URL = "https://openrouter.ai/api/v1/chat/completions"
    private const val DEFAULT_MODEL = "x-ai/grok-4.1-fast"

    fun init(context: Context) {
        prefs = context.getSharedPreferences(PREF_AI, Context.MODE_PRIVATE)
    }

    // [修改] 支持存储多行 Key
    var apiKeys: String
        get() = prefs.getString("api_keys", "") ?: ""
        set(value) = prefs.edit().putString("api_keys", value).apply()

    // 获取 Key 列表
    fun getKeyList(): List<String> {
        return apiKeys.split("\n")
            .map { it.trim() }
            .filter { it.isNotBlank() }
    }

    var model: String
        get() = prefs.getString("model", DEFAULT_MODEL) ?: DEFAULT_MODEL
        set(value) = prefs.edit().putString("model", value).apply()

    var baseUrl: String
        get() = prefs.getString("base_url", DEFAULT_BASE_URL) ?: DEFAULT_BASE_URL
        set(value) = prefs.edit().putString("base_url", value).apply()

    // [新增] 代理设置
    var enableProxy: Boolean
        get() = prefs.getBoolean("enable_proxy", false)
        set(value) = prefs.edit().putBoolean("enable_proxy", value).apply()

    var proxyHost: String
        get() = prefs.getString("proxy_host", "127.0.0.1") ?: "127.0.0.1"
        set(value) = prefs.edit().putString("proxy_host", value).apply()

    var proxyPort: String
        get() = prefs.getString("proxy_port", "7890") ?: "7890"
        set(value) = prefs.edit().putString("proxy_port", value).apply()

    fun isConfigured(): Boolean = getKeyList().isNotEmpty()
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\remote\UpdateManager.kt ---
```kt
package com.example.killquestion.data.remote

import android.content.Context
import android.content.Intent
import android.net.Uri
import com.google.gson.Gson
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.net.URL

data class AppVersion(
    val versionCode: Int,
    val versionName: String,
    val downloadUrl: String,
    val note: String
)

object UpdateManager {
    private const val VERSION_URL = "https://xn--r7qu00bb2c.top/version.json" // 你的版本文件地址

    suspend fun checkUpdate(context: Context): AppVersion? {
        return withContext(Dispatchers.IO) {
            try {
                val json = URL(VERSION_URL).readText()
                val remoteVersion = Gson().fromJson(json, AppVersion::class.java)

                // 获取当前 App 版本
                val pInfo = context.packageManager.getPackageInfo(context.packageName, 0)
                val currentVersionCode = if (android.os.Build.VERSION.SDK_INT >= 28) {
                    pInfo.longVersionCode.toInt()
                } else {
                    pInfo.versionCode
                }

                if (remoteVersion.versionCode > currentVersionCode) {
                    remoteVersion
                } else {
                    null // 没有新版本
                }
            } catch (e: Exception) {
                e.printStackTrace()
                null
            }
        }
    }

    fun openBrowserDownload(context: Context, url: String) {
        try {
            val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            context.startActivity(intent)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\data\repository\QuestionRepository.kt ---
```kt
package com.example.killquestion.data.repository

import android.content.Context
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.setValue
import com.example.killquestion.data.local.CustomQuestionStorage
import com.example.killquestion.data.local.MistakeManager
import com.example.killquestion.data.local.ProgressManager // 确保导入了 ProgressManager
import com.example.killquestion.data.model.Question
import com.example.killquestion.data.model.QuestionWrapper
import com.example.killquestion.util.ChineseStringComparator
import com.google.gson.Gson
import java.io.IOException

object QuestionRepository {
    private var allQuestions = mutableListOf<Question>() // 改为 MutableList
    var isLoaded by mutableStateOf(false)
    var loadError by mutableStateOf<String?>(null)

    private var questionsByCategory = mutableMapOf<String, List<Question>>()
    var categoryList by mutableStateOf(listOf<String>())

    private var questionsByChapter = mutableMapOf<String, List<Question>>()
    var chapterList by mutableStateOf(listOf<String>())

    private var questionsById = mutableMapOf<String, Question>()

    fun load(context: Context) {
        if (isLoaded) return

        try {
            // 1. 加载 assets 里的静态题库
            val jsonString = context.assets.open("questions_full.json").bufferedReader().use { it.readText() }
            val wrapper = Gson().fromJson(jsonString, QuestionWrapper::class.java)
            val staticQuestions = wrapper.data

            // 2. 加载本地存储的动态题库 (联网搜的题)
            val customQuestions = CustomQuestionStorage.getAll()

            // 3. 合并
            allQuestions.clear()
            allQuestions.addAll(staticQuestions)
            allQuestions.addAll(customQuestions)

            // 4. 重建索引
            refreshIndexes()

            isLoaded = true
        } catch (e: IOException) {
            loadError = "未找到题库文件 (questions_full.json)。"
        } catch (e: Exception) {
            loadError = "数据解析错误: ${e.message}"
        }
    }

    // 当联网生成新题时，调用此方法更新内存
    fun addDynamicQuestions(newQuestions: List<Question>) {
        CustomQuestionStorage.saveQuestions(newQuestions) // 持久化保存
        allQuestions.addAll(newQuestions) // 添加到内存列表
        refreshIndexes() // 刷新索引
    }

    private fun refreshIndexes() {
        val groupedCat = allQuestions.groupBy { it.category }
        questionsByCategory.clear() // 清理旧数据
        questionsByCategory.putAll(groupedCat)
        categoryList = groupedCat.keys.filter { !it.contains("B型") }.sortedWith(ChineseStringComparator())

        val groupedChap = allQuestions.groupBy { it.chapter }
        questionsByChapter.clear() // 清理旧数据
        questionsByChapter.putAll(groupedChap)
        chapterList = groupedChap.keys.sortedWith(ChineseStringComparator())

        questionsById = allQuestions.associateBy { it.id }.toMutableMap()
    }

    fun getQuestionsByCategory(category: String) = questionsByCategory[category] ?: emptyList()
    fun getQuestionsByChapter(chapter: String) = questionsByChapter[chapter] ?: emptyList()

    // [核心修复] 获取错题列表
    // 增加 filter 逻辑：如果 MistakeManager 里有 ID，但 allQuestions 里找不到这题（说明已被删除），则过滤掉
    fun getMistakeQuestions(): List<Question> {
        val mistakeIds = MistakeManager.getAllMistakeIds()
        return mistakeIds.mapNotNull { questionsById[it] }
    }

    fun getTotalCount(): Int = allQuestions.size

    // [核心修复] 删除章节并联动清理数据
    fun deleteChapter(chapterName: String) {
        // 1. 找出该章节下的所有题目
        val questionsToDelete = allQuestions.filter { it.chapter == chapterName }

        if (questionsToDelete.isEmpty()) return

        // 2. 提取这些题目的 ID
        val idsToDelete = questionsToDelete.map { it.id }

        // 3. [关键步骤] 通知 Managers 清理数据
        // 这会让首页的错题数立即下降，进度记录也会被清除
        MistakeManager.removeMistakes(idsToDelete)
        ProgressManager.removeRecords(idsToDelete)

        // 4. 从持久化存储中删除
        CustomQuestionStorage.deleteQuestionsByChapter(chapterName)

        // 5. 从内存列表中删除
        allQuestions.removeAll(questionsToDelete)

        // 6. 刷新索引 (Category 和 Chapter 映射)
        refreshIndexes()
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\components\BusinessComponents.kt ---
```kt
package com.example.killquestion.ui.components

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.offset
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.killquestion.ui.theme.TextPrimary
import com.example.killquestion.ui.theme.TextSecondary
import androidx.compose.foundation.BorderStroke

@Composable
fun StatCard(modifier: Modifier, label: String, value: String, icon: ImageVector, accentColor: Color) {
    GlassyCard(
        modifier = modifier.height(90.dp),
        backgroundColor = Color.White.copy(alpha = 0.9f),
        elevation = 0.dp,
        border = null
    ) {
        Row(
            modifier = Modifier
                .fillMaxSize()
                .padding(horizontal = 8.dp),
            verticalAlignment = Alignment.CenterVertically,
            horizontalArrangement = Arrangement.Start
        ) {
            Box(
                modifier = Modifier
                    .size(44.dp)
                    .clip(CircleShape)
                    .background(accentColor.copy(alpha = 0.1f)),
                contentAlignment = Alignment.Center
            ) {
                Icon(icon, null, tint = accentColor, modifier = Modifier.size(22.dp))
            }
            Spacer(modifier = Modifier.width(12.dp))
            Column(
                horizontalAlignment = Alignment.Start
            ) {
                Text(value, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, color = TextPrimary)
                Text(label, style = MaterialTheme.typography.labelSmall, color = TextSecondary)
            }
        }
    }
}

@Composable
fun MenuCard(title: String, subtitle: String, icon: ImageVector, gradient: Brush, onClick: () -> Unit) {
    BouncyButton(onClick = onClick) {
        Surface(
            modifier = Modifier
                .fillMaxWidth()
                .height(100.dp),
            shape = RoundedCornerShape(24.dp),
            shadowElevation = 0.dp,
            color = Color.Transparent
        ) {
            Box(modifier = Modifier.background(gradient)) {
                Icon(
                    imageVector = icon,
                    contentDescription = null,
                    modifier = Modifier
                        .align(Alignment.CenterEnd)
                        .offset(x = 20.dp, y = 10.dp)
                        .size(120.dp)
                        .graphicsLayer { alpha = 0.1f; rotationZ = -15f },
                    tint = Color.White
                )

                Row(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(horizontal = 24.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Box(
                        modifier = Modifier
                            .size(52.dp)
                            .clip(RoundedCornerShape(14.dp))
                            .background(Color.White.copy(alpha = 0.2f)),
                        contentAlignment = Alignment.Center
                    ) {
                        Icon(icon, null, tint = Color.White, modifier = Modifier.size(28.dp))
                    }

                    Spacer(modifier = Modifier.width(20.dp))

                    Column {
                        Text(title, style = MaterialTheme.typography.headlineSmall, fontWeight = FontWeight.Bold, color = Color.White, fontSize = 20.sp)
                        Text(subtitle, style = MaterialTheme.typography.bodyMedium, color = Color.White.copy(alpha = 0.8f))
                    }
                }
            }
        }
    }
}

@Composable
fun TypeCapsule(text: String, color: Color) {
    Surface(
        color = color.copy(alpha = 0.1f),
        shape = RoundedCornerShape(8.dp),
        border = BorderStroke(1.dp, color.copy(alpha = 0.2f))
    ) {
        Text(
            text = text,
            style = MaterialTheme.typography.labelMedium,
            fontWeight = FontWeight.Bold,
            modifier = Modifier.padding(horizontal = 10.dp, vertical = 6.dp),
            color = color
        )
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\components\CommonUi.kt ---
```kt
package com.example.killquestion.ui.components

import androidx.compose.animation.core.animateFloatAsState
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.interaction.collectIsPressedAsState
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.BoxScope
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Icon
import androidx.compose.material3.Surface
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.scale
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import com.example.killquestion.ui.theme.*

@Composable
fun AnimatedBackground() {
    Canvas(modifier = Modifier.fillMaxSize()) {
        drawRect(
            brush = Brush.verticalGradient(
                colors = listOf(ZenBackgroundStart, ZenBackgroundEnd)
            )
        )
        drawCircle(
            color = ZenGreenAccent.copy(alpha = 0.05f),
            radius = size.width * 0.8f,
            center = Offset(size.width * 0.9f, size.height * 0.1f)
        )
        drawCircle(
            color = ZenGreenPrimary.copy(alpha = 0.03f),
            radius = size.width * 0.6f,
            center = Offset(size.width * 0.1f, size.height * 0.9f)
        )
    }
}

@Composable
fun BouncyButton(
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
    scaleDown: Float = 0.95f,
    content: @Composable BoxScope.() -> Unit
) {
    val interactionSource = remember { MutableInteractionSource() }
    val isPressed by interactionSource.collectIsPressedAsState()
    val scale by animateFloatAsState(
        targetValue = if (isPressed) scaleDown else 1f,
        label = "scale"
    )

    Box(
        modifier = modifier
            .scale(scale)
            .clickable(
                interactionSource = interactionSource,
                indication = null,
                onClick = onClick
            ),
        content = content
    )
}

@Composable
fun GlassyCard(
    modifier: Modifier = Modifier,
    shape: RoundedCornerShape = RoundedCornerShape(20.dp),
    backgroundColor: Color = ZenSurface,
    elevation: Dp = 4.dp,
    border: BorderStroke? = null,
    content: @Composable BoxScope.() -> Unit
) {
    Surface(
        modifier = modifier,
        shape = shape,
        color = backgroundColor,
        shadowElevation = elevation,
        border = border
    ) {
        Box(modifier = Modifier.fillMaxSize()) {
            content()
        }
    }
}

@Composable
fun SmallIconButton(
    icon: ImageVector,
    onClick: () -> Unit,
    tint: Color = TextSecondary,
    containerColor: Color = Color.White
) {
    Surface(
        onClick = onClick,
        shape = CircleShape,
        color = containerColor,
        border = if (containerColor == Color.White) BorderStroke(1.dp, Color.Black.copy(0.05f)) else null,
        modifier = Modifier.size(40.dp)
    ) {
        Box(contentAlignment = Alignment.Center) {
            Icon(icon, null, tint = tint, modifier = Modifier.size(20.dp))
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\components\MarkdownText.kt ---
```kt
package com.example.killquestion.ui.components

import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.remember
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.AnnotatedString
import androidx.compose.ui.text.SpanStyle
import androidx.compose.ui.text.buildAnnotatedString
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.withStyle
import androidx.compose.ui.unit.sp
import com.example.killquestion.ui.theme.TextPrimary
import com.example.killquestion.ui.theme.ZenGreenPrimary

@Composable
fun MarkdownText(
    markdown: String,
    modifier: Modifier = Modifier,
    color: Color = TextPrimary,
    fontSize: androidx.compose.ui.unit.TextUnit = 16.sp,
    lineHeight: androidx.compose.ui.unit.TextUnit = 28.sp
) {
    val styledText = remember(markdown) {
        buildAnnotatedString {
            val lines = markdown.split("\n")
            lines.forEachIndexed { index, line ->
                val currentLine = line.trim()

                // 1. 处理标题 (#, ##)
                if (currentLine.startsWith("#")) {
                    val level = currentLine.takeWhile { it == '#' }.length
                    val content = currentLine.removePrefix("#".repeat(level)).trim()

                    withStyle(
                        style = SpanStyle(
                            fontWeight = FontWeight.Black,
                            fontSize = fontSize * (1.5f - level * 0.1f),
                            color = ZenGreenPrimary
                        )
                    ) {
                        appendMarkdownContent(content, isHeader = true)
                    }
                }
                // 2. 处理列表 (- , * )
                else if (currentLine.startsWith("- ") || currentLine.startsWith("* ")) {
                    withStyle(style = SpanStyle(fontWeight = FontWeight.Bold, color = ZenGreenPrimary)) {
                        append("• ")
                    }
                    appendMarkdownContent(currentLine.substring(2), baseColor = color)
                }
                // 3. 普通文本
                else {
                    appendMarkdownContent(currentLine, baseColor = color)
                }

                if (index < lines.size - 1) {
                    append("\n")
                }
            }
        }
    }

    Text(
        text = styledText,
        modifier = modifier,
        color = color,
        fontSize = fontSize,
        lineHeight = lineHeight
    )
}

fun AnnotatedString.Builder.appendMarkdownContent(
    text: String,
    baseColor: Color = TextPrimary,
    isHeader: Boolean = false
) {
    val boldRegex = Regex("\\*\\*(.*?)\\*\\*")
    var lastIndex = 0

    boldRegex.findAll(text).forEach { matchResult ->
        val normalText = text.substring(lastIndex, matchResult.range.first)
        if (normalText.isNotEmpty()) {
            if (!isHeader) {
                withStyle(style = SpanStyle(color = baseColor)) {
                    append(normalText)
                }
            } else {
                append(normalText)
            }
        }

        val boldContent = matchResult.groupValues[1]
        withStyle(
            style = SpanStyle(
                fontWeight = FontWeight.ExtraBold,
                color = if (isHeader) ZenGreenPrimary else Color(0xFF1F2937)
            )
        ) {
            append(boldContent)
        }

        lastIndex = matchResult.range.last + 1
    }

    if (lastIndex < text.length) {
        val remainingText = text.substring(lastIndex)
        if (!isHeader) {
            withStyle(style = SpanStyle(color = baseColor)) {
                append(remainingText)
            }
        } else {
            append(remainingText)
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\dialogs\AppDialogs.kt ---
```kt
package com.example.killquestion.ui.dialogs

import androidx.compose.animation.core.*
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.blur
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.TileMode
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import androidx.compose.ui.zIndex
import coil.compose.AsyncImage
import coil.request.ImageRequest
import com.example.killquestion.data.local.FontConfig
import com.example.killquestion.data.local.FontManager
import com.example.killquestion.data.local.ProgressManager
import com.example.killquestion.data.remote.AiConfigManager
import com.example.killquestion.data.remote.AppVersion
import com.example.killquestion.data.remote.SimpleAiClient
import com.example.killquestion.data.remote.UpdateManager
import com.example.killquestion.ui.components.BouncyButton
import com.example.killquestion.ui.components.MarkdownText
import com.example.killquestion.ui.theme.*
import com.example.killquestion.utils.ImageSaver
import kotlinx.coroutines.launch
import java.util.regex.Pattern

// [通用组件] 流光边框弹窗容器
@Composable
fun RainbowBorderDialogSurface(
    onDismiss: () -> Unit,
    content: @Composable () -> Unit
) {
    val scaleAnim = remember { Animatable(0.9f) }
    val infiniteTransition = rememberInfiniteTransition(label = "flow")
    val offsetAnim by infiniteTransition.animateFloat(
        initialValue = 0f,
        targetValue = 2000f,
        animationSpec = infiniteRepeatable(
            animation = tween(durationMillis = 3000, easing = LinearEasing),
            repeatMode = RepeatMode.Restart
        ), label = "flow_offset"
    )

    LaunchedEffect(Unit) {
        scaleAnim.animateTo(1f, spring(Spring.DampingRatioMediumBouncy, Spring.StiffnessLow))
    }

    val flowBrush = Brush.linearGradient(
        colors = RainbowColors,
        start = Offset(offsetAnim, offsetAnim),
        end = Offset(offsetAnim + 1000f, offsetAnim + 1000f),
        tileMode = TileMode.Mirror
    )

    Dialog(onDismissRequest = onDismiss) {
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .wrapContentHeight()
                .graphicsLayer { scaleX = scaleAnim.value; scaleY = scaleAnim.value }
        ) {
            // 背景层（流光）
            Box(
                modifier = Modifier
                    .matchParentSize()
                    .scale(1.03f)
                    .clip(RoundedCornerShape(28.dp))
                    .background(flowBrush)
                    .blur(16.dp)
            )

            // 内容层
            Surface(
                modifier = Modifier.fillMaxWidth(),
                shape = RoundedCornerShape(24.dp),
                color = Color.White,
                shadowElevation = 0.dp
            ) {
                Box {
                    IconButton(
                        onClick = onDismiss,
                        modifier = Modifier
                            .align(Alignment.TopEnd)
                            .padding(12.dp)
                            .zIndex(1f)
                    ) {
                        Icon(Icons.Default.Close, null, tint = TextSecondary)
                    }
                    content()
                }
            }
        }
    }
}

// [弹窗] AI 图片生成 (支持 Coil 显示和 ImageSaver 保存)
@Composable
fun AiImageDialog(onDismiss: () -> Unit) {
    val context = LocalContext.current
    var prompt by remember { mutableStateOf("") }
    var resultMarkdown by remember { mutableStateOf("") }
    var isGenerating by remember { mutableStateOf(false) }
    var isSaving by remember { mutableStateOf(false) }
    val scope = rememberCoroutineScope()

    // 正则提取 URL: ![Image](https://...) -> 提取括号内的链接
    val imageUrl = remember(resultMarkdown) {
        val pattern = Pattern.compile("\\((https?://.*?)\\)")
        val matcher = pattern.matcher(resultMarkdown)
        if (matcher.find()) matcher.group(1) else null
    }

    RainbowBorderDialogSurface(onDismiss = onDismiss) {
        Column(modifier = Modifier.padding(24.dp)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Icon(Icons.Default.Image, null, tint = ZenGreenPrimary, modifier = Modifier.size(28.dp))
                Spacer(modifier = Modifier.width(12.dp))
                Text("AI 灵感绘图", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
            }
            Spacer(modifier = Modifier.height(8.dp))
            Text("输入中文描述，AI 自动润色并生成大片", style = MaterialTheme.typography.bodySmall, color = TextSecondary)

            Spacer(modifier = Modifier.height(16.dp))

            OutlinedTextField(
                value = prompt,
                onValueChange = { prompt = it },
                label = { Text("画面描述") },
                placeholder = { Text("例如：一只在太空中喝咖啡的赛博朋克猫咪") },
                modifier = Modifier.fillMaxWidth(),
                minLines = 3,
                maxLines = 5,
                shape = RoundedCornerShape(16.dp),
                colors = OutlinedTextFieldDefaults.colors(
                    focusedBorderColor = ZenGreenPrimary,
                    unfocusedBorderColor = Color(0xFFE2E8F0)
                )
            )

            Spacer(modifier = Modifier.height(16.dp))

            BouncyButton(
                onClick = {
                    if (prompt.isNotBlank()) {
                        isGenerating = true
                        resultMarkdown = ""
                        scope.launch {
                            SimpleAiClient.generateImageCreation(prompt).collect {
                                resultMarkdown += it
                            }
                            isGenerating = false
                        }
                    }
                },
                modifier = Modifier.fillMaxWidth().height(48.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(if (isGenerating) Color.Gray else ZenGreenPrimary, RoundedCornerShape(12.dp)),
                    contentAlignment = Alignment.Center
                ) {
                    if (isGenerating) {
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            CircularProgressIndicator(color = Color.White, modifier = Modifier.size(16.dp), strokeWidth = 2.dp)
                            Spacer(modifier = Modifier.width(8.dp))
                            Text("正在构思画面...", color = Color.White, fontWeight = FontWeight.Bold)
                        }
                    } else {
                        Text("立即生成", color = Color.White, fontWeight = FontWeight.Bold)
                    }
                }
            }

            // 图片展示区
            if (resultMarkdown.isNotBlank()) {
                Spacer(modifier = Modifier.height(16.dp))
                Divider(color = Color(0xFFF1F5F9))
                Spacer(modifier = Modifier.height(16.dp))

                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .aspectRatio(1f)
                        .clip(RoundedCornerShape(16.dp))
                        .background(Color(0xFFF8FAFC)),
                    contentAlignment = Alignment.Center
                ) {
                    if (imageUrl != null) {
                        // 1. 显示网络图片
                        AsyncImage(
                            model = ImageRequest.Builder(LocalContext.current)
                                .data(imageUrl)
                                .crossfade(true)
                                .build(),
                            contentDescription = "AI Generated Image",
                            modifier = Modifier.fillMaxSize(),
                            contentScale = ContentScale.Crop
                        )

                        // 2. 右上角下载按钮 (非生成状态下显示)
                        if (!isGenerating) {
                            IconButton(
                                onClick = {
                                    if (!isSaving) {
                                        isSaving = true
                                        scope.launch {
                                            ImageSaver.saveImageToGallery(context, imageUrl)
                                            isSaving = false
                                        }
                                    }
                                },
                                modifier = Modifier
                                    .align(Alignment.TopEnd)
                                    .padding(8.dp)
                                    .size(36.dp)
                                    .background(Color.Black.copy(alpha = 0.4f), CircleShape)
                            ) {
                                if (isSaving) {
                                    CircularProgressIndicator(modifier = Modifier.size(18.dp), color = Color.White, strokeWidth = 2.dp)
                                } else {
                                    Icon(
                                        imageVector = Icons.Default.Download,
                                        contentDescription = "保存",
                                        tint = Color.White,
                                        modifier = Modifier.size(20.dp)
                                    )
                                }
                            }
                        }
                    } else {
                        // 如果还在生成或解析失败，显示原始文本
                        Box(modifier = Modifier.padding(16.dp)) {
                            MarkdownText(
                                markdown = resultMarkdown,
                                color = TextPrimary,
                                fontSize = 12.sp
                            )
                        }
                    }
                }

                if (!isGenerating && imageUrl == null) {
                    Text(
                        "生成失败，未能获取图片链接",
                        color = ColorMistake,
                        fontSize = 12.sp,
                        modifier = Modifier.padding(top = 8.dp).align(Alignment.CenterHorizontally)
                    )
                }
            }
        }
    }
}

// [弹窗] 设置 (包含字体下载进度、多行Key、代理、更新)
@Composable
fun SettingsDialog(onDismiss: () -> Unit) {
    val context = LocalContext.current

    var apiKeys by remember { mutableStateOf(AiConfigManager.apiKeys) }
    var model by remember { mutableStateOf(AiConfigManager.model) }
    var baseUrl by remember { mutableStateOf(AiConfigManager.baseUrl) }
    var enableProxy by remember { mutableStateOf(AiConfigManager.enableProxy) }
    var proxyHost by remember { mutableStateOf(AiConfigManager.proxyHost) }
    var proxyPort by remember { mutableStateOf(AiConfigManager.proxyPort) }

    var refreshTrigger by remember { mutableStateOf(0) }
    var showUpdateDialog by remember { mutableStateOf(false) }
    var newVersion by remember { mutableStateOf<AppVersion?>(null) }
    var isCheckingUpdate by remember { mutableStateOf(false) }
    var updateCheckMessage by remember { mutableStateOf<String?>(null) }
    val scope = rememberCoroutineScope()

    if (showUpdateDialog && newVersion != null) {
        AlertDialog(
            onDismissRequest = { showUpdateDialog = false },
            title = { Text("发现新版本 ${newVersion!!.versionName}", fontWeight = FontWeight.Bold) },
            text = { Text(newVersion!!.note) },
            confirmButton = {
                TextButton(onClick = { UpdateManager.openBrowserDownload(context, newVersion!!.downloadUrl); showUpdateDialog = false }) {
                    Text("去下载", color = ZenGreenPrimary, fontWeight = FontWeight.Bold)
                }
            },
            dismissButton = { TextButton(onClick = { showUpdateDialog = false }) { Text("暂不更新", color = TextSecondary) } }
        )
    }

    RainbowBorderDialogSurface(onDismiss = onDismiss) {
        Column(
            modifier = Modifier
                .padding(24.dp)
                .heightIn(max = 700.dp)
        ) {
            Text("全局设置", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, color = ZenDark)
            Spacer(modifier = Modifier.height(16.dp))

            // --- 字体列表 ---
            Text("字体风格 (点击下载)", style = MaterialTheme.typography.labelMedium, color = TextSecondary)
            Spacer(modifier = Modifier.height(12.dp))
            LazyVerticalGrid(
                columns = GridCells.Fixed(2),
                horizontalArrangement = Arrangement.spacedBy(8.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp),
                modifier = Modifier.height(110.dp)
            ) {
                items(FontManager.fontList) { fontConfig: FontConfig ->
                    val isSelected = FontManager.currentFontName == fontConfig.name
                    val isDownloaded = FontManager.isFontDownloaded(fontConfig.code)
                    var downloadProgress by remember { mutableFloatStateOf(-1f) }
                    val isDownloading = downloadProgress >= 0f
                    val bgColor = if (isSelected) ZenGreenPrimary.copy(alpha = 0.1f) else Color(0xFFF1F5F9)
                    val borderColor = if (isSelected) ZenGreenPrimary else Color.Transparent

                    Surface(
                        shape = RoundedCornerShape(12.dp), color = bgColor, border = BorderStroke(2.dp, borderColor),
                        modifier = Modifier.height(50.dp).clickable(enabled = !isDownloading) {
                            if (isDownloaded) FontManager.switchFont(fontConfig.code)
                            else {
                                downloadProgress = 0f
                                scope.launch {
                                    val success = FontManager.downloadFont(fontConfig.code) { p -> downloadProgress = p }
                                    downloadProgress = -1f
                                    if (success) refreshTrigger++
                                }
                            }
                        }
                    ) {
                        Row(verticalAlignment = Alignment.CenterVertically, horizontalArrangement = Arrangement.Center, modifier = Modifier.fillMaxSize()) {
                            Text(fontConfig.name, fontSize = 12.sp, fontWeight = if (isSelected) FontWeight.Bold else FontWeight.Normal, color = if (isSelected) ZenGreenPrimary else TextPrimary)
                            Spacer(modifier = Modifier.width(4.dp))
                            if (isDownloading) CircularProgressIndicator(progress = { downloadProgress }, modifier = Modifier.size(14.dp), strokeWidth = 2.dp, color = ZenGreenPrimary, trackColor = ZenGreenPrimary.copy(alpha = 0.2f))
                            else if (isSelected) Icon(Icons.Default.Check, null, modifier = Modifier.size(14.dp), tint = ZenGreenPrimary)
                            else if (!isDownloaded) Icon(Icons.Default.CloudDownload, null, modifier = Modifier.size(14.dp), tint = TextSecondary)
                        }
                    }
                }
            }

            Spacer(modifier = Modifier.height(16.dp))
            Divider(color = Color(0xFFF1F5F9))
            Spacer(modifier = Modifier.height(16.dp))

            // --- AI & 代理设置 (可滚动) ---
            Column(
                modifier = Modifier.weight(1f, fill = false).verticalScroll(rememberScrollState()),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text("AI 配置 (OpenRouter)", style = MaterialTheme.typography.labelMedium, color = TextSecondary)
                OutlinedTextField(value = apiKeys, onValueChange = { apiKeys = it }, label = { Text("Keys") }, placeholder = { Text("API Keys (换行分隔)") }, modifier = Modifier.fillMaxWidth(), minLines = 1, maxLines = 3, textStyle = TextStyle(fontSize = 12.sp))
                OutlinedTextField(value = model, onValueChange = { model = it }, label = { Text("Models") }, placeholder = { Text("x-ai/grok-4.1-fast") }, modifier = Modifier.fillMaxWidth(), singleLine = true, textStyle = TextStyle(fontSize = 12.sp))
                OutlinedTextField(value = baseUrl, onValueChange = { baseUrl = it }, label = { Text("API") }, modifier = Modifier.fillMaxWidth(), singleLine = true, textStyle = TextStyle(fontSize = 12.sp))

                Spacer(modifier = Modifier.height(8.dp))

                // 代理与更新
                Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween) {
                    Row(verticalAlignment = Alignment.CenterVertically, modifier = Modifier.offset(x = (-12).dp)) {
                        Checkbox(checked = enableProxy, onCheckedChange = { enableProxy = it })
                        Text("全局代理", fontSize = 14.sp, color = TextPrimary)
                    }
                    Surface(shape = RoundedCornerShape(12.dp), color = Color(0xFFF8FAFC), border = BorderStroke(1.dp, Color(0xFFE2E8F0)), modifier = Modifier.height(32.dp).clickable(enabled = !isCheckingUpdate) {
                        isCheckingUpdate = true; updateCheckMessage = null
                        scope.launch {
                            val version = UpdateManager.checkUpdate(context); isCheckingUpdate = false
                            if (version != null) { newVersion = version; showUpdateDialog = true } else { updateCheckMessage = "已是最新" }
                        }
                    }) {
                        Box(contentAlignment = Alignment.Center, modifier = Modifier.padding(horizontal = 12.dp)) {
                            if (isCheckingUpdate) CircularProgressIndicator(modifier = Modifier.size(12.dp), strokeWidth = 2.dp, color = ZenGreenPrimary)
                            else Text(text = updateCheckMessage ?: "检查更新", fontSize = 11.sp, color = if (updateCheckMessage != null) ZenGreenPrimary else TextSecondary, fontWeight = FontWeight.Medium)
                        }
                    }
                }

                if (enableProxy) {
                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                        OutlinedTextField(value = proxyHost, onValueChange = { proxyHost = it }, label = { Text("主机") }, placeholder = { Text("如 127.0.0.1") }, modifier = Modifier.weight(2f), singleLine = true, minLines = 1, textStyle = TextStyle(fontSize = 12.sp))
                        OutlinedTextField(value = proxyPort, onValueChange = { if (it.all { c -> c.isDigit() }) proxyPort = it }, label = { Text("端口") }, placeholder = { Text("如 7890") }, modifier = Modifier.weight(1f), singleLine = true, minLines = 1, keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number), textStyle = TextStyle(fontSize = 12.sp))
                    }
                    Text("注：请在VPN软件中开启'允许局域网/HTTP代理'，通常主机为 127.0.0.1", fontSize = 10.sp, color = TextSecondary, lineHeight = 14.sp)
                }
            }

            Spacer(modifier = Modifier.height(16.dp))
            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.End) {
                TextButton(onClick = onDismiss) { Text("取消", color = TextSecondary) }
                Spacer(modifier = Modifier.width(8.dp))
                Button(onClick = {
                    AiConfigManager.apiKeys = apiKeys.trim(); AiConfigManager.model = model.trim(); AiConfigManager.baseUrl = baseUrl.trim()
                    AiConfigManager.enableProxy = enableProxy; AiConfigManager.proxyHost = proxyHost.trim(); AiConfigManager.proxyPort = proxyPort.trim()
                    onDismiss()
                }, colors = ButtonDefaults.buttonColors(containerColor = ZenGreenPrimary)) { Text("保存") }
            }
        }
    }
}

// [弹窗] 使用说明
@Composable
fun GuideDialog(onDismiss: () -> Unit) {
    RainbowBorderDialogSurface(onDismiss = onDismiss) {
        Column(modifier = Modifier.padding(24.dp)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Icon(Icons.Default.Info, null, tint = ZenGreenPrimary)
                Spacer(modifier = Modifier.width(8.dp))
                Text("使用说明", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
            }
            Spacer(modifier = Modifier.height(16.dp))

            val steps = listOf(
                "1. 首页模式" to "支持按章节顺序刷题，或按题型专项训练。",
                "2. 联网刷题" to "输入关键词（如“太阳病”），AI 会实时生成 10 道新题。支持自动存入本地题库。",
                "3. AI 绘图" to "输入中文描述，AI 自动生成精美插图。",
                "4. 错题复习" to "做错的题会自动加入错题本，答对一次即可移除。",
                "5. AI 助教" to "答题时点击 ✨，AI 会深度解析当前题目，点击刷新可重新提问。",
                "6. 更多惊喜" to "App 内隐藏了一些有趣的彩蛋，试着在首页多点点看？"
            )

            steps.forEach { (title, desc) ->
                Text(title, fontWeight = FontWeight.Bold, color = ZenGreenPrimary, fontSize = 15.sp)
                Text(desc, color = TextSecondary, fontSize = 14.sp, lineHeight = 20.sp)
                Spacer(modifier = Modifier.height(12.dp))
            }

            Button(
                onClick = onDismiss,
                modifier = Modifier.fillMaxWidth().padding(top = 8.dp),
                colors = ButtonDefaults.buttonColors(containerColor = ZenGreenPrimary)
            ) {
                Text("我知道了")
            }
        }
    }
}

// [弹窗] 快速跳转
@Composable
fun JumpDialog(totalCount: Int, currentIndex: Int, onDismiss: () -> Unit, onJump: (Int) -> Unit) {
    Dialog(onDismissRequest = onDismiss) {
        Surface(
            modifier = Modifier.fillMaxWidth().fillMaxHeight(0.6f).padding(16.dp),
            shape = RoundedCornerShape(24.dp), color = Color.White, shadowElevation = 2.dp
        ) {
            Column(modifier = Modifier.padding(24.dp)) {
                Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                    Text("快速跳转", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold)
                    IconButton(onClick = onDismiss) { Icon(Icons.Default.Close, null, tint = TextSecondary) }
                }
                Spacer(modifier = Modifier.height(16.dp))
                LazyVerticalGrid(columns = GridCells.Adaptive(minSize = 56.dp), horizontalArrangement = Arrangement.spacedBy(12.dp), verticalArrangement = Arrangement.spacedBy(12.dp), modifier = Modifier.weight(1f)) {
                    items(totalCount) { index ->
                        val isCurrent = index == currentIndex; val isCompleted = ProgressManager.isCompleted(index.toString())
                        Box(modifier = Modifier.aspectRatio(1f).clip(RoundedCornerShape(12.dp)).background(if (isCurrent) ZenGreenPrimary else if (isCompleted) ZenGreenAccent.copy(alpha = 0.2f) else Color(0xFFF1F5F9)).clickable { onJump(index) }, contentAlignment = Alignment.Center) {
                            Text(text = "${index + 1}", color = if (isCurrent) Color.White else TextPrimary, fontWeight = if (isCurrent) FontWeight.Bold else FontWeight.Normal)
                        }
                    }
                }
            }
        }
    }
}

// [弹窗] 彩蛋
@Composable
fun EasterEggDialog(onDismiss: () -> Unit) {
    RainbowBorderDialogSurface(onDismiss = onDismiss) {
        Column(
            modifier = Modifier.fillMaxWidth().padding(top = 48.dp, bottom = 40.dp, start = 24.dp, end = 24.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(text = "🎉", fontSize = 80.sp, textAlign = TextAlign.Center)
            Spacer(modifier = Modifier.height(24.dp))
            val infiniteTransition = rememberInfiniteTransition(label = "text_flow")
            val offsetAnim by infiniteTransition.animateFloat(initialValue = 0f, targetValue = 1000f, animationSpec = infiniteRepeatable(tween(2000, easing = LinearEasing), RepeatMode.Restart), label = "")
            val textBrush = Brush.linearGradient(colors = RainbowColors, start = Offset(offsetAnim, 0f), end = Offset(offsetAnim + 500f, 0f), tileMode = TileMode.Mirror)

            Text(text = "彩蛋解锁", style = TextStyle(brush = textBrush, fontSize = 32.sp, fontWeight = FontWeight.Black), textAlign = TextAlign.Center)
            Spacer(modifier = Modifier.height(28.dp))
            Text(text = "邱邱宝宝加油加油\n你的老公永远爱你", fontSize = 22.sp, fontWeight = FontWeight.Bold, color = Color(0xFF374151), lineHeight = 34.sp, textAlign = TextAlign.Center)
        }
    }
}

// [弹窗] AI 响应结果
@Composable
fun AiResponseDialog(content: String, isLoading: Boolean, onDismiss: () -> Unit, onRefresh: () -> Unit) {
    val scaleAnim = remember { Animatable(0.8f) }
    val infiniteTransition = rememberInfiniteTransition(label = "ai_flow")
    val offsetAnim by infiniteTransition.animateFloat(initialValue = 0f, targetValue = 2000f, animationSpec = infiniteRepeatable(tween(3000, easing = LinearEasing), RepeatMode.Restart), label = "")
    val flowBrush = Brush.linearGradient(colors = RainbowColors, start = Offset(offsetAnim, offsetAnim), end = Offset(offsetAnim + 1000f, offsetAnim + 1000f), tileMode = TileMode.Mirror)
    LaunchedEffect(Unit) { scaleAnim.animateTo(1f, spring(Spring.DampingRatioMediumBouncy, Spring.StiffnessLow)) }

    Dialog(onDismissRequest = onDismiss) {
        Box(modifier = Modifier.fillMaxWidth().fillMaxHeight(0.85f).graphicsLayer { scaleX = scaleAnim.value; scaleY = scaleAnim.value }) {
            Box(modifier = Modifier.matchParentSize().scale(1.02f).clip(RoundedCornerShape(28.dp)).background(flowBrush).blur(16.dp))
            Surface(modifier = Modifier.fillMaxSize(), shape = RoundedCornerShape(24.dp), color = Color.White) {
                Column(modifier = Modifier.fillMaxSize()) {
                    Row(modifier = Modifier.fillMaxWidth().padding(16.dp), horizontalArrangement = Arrangement.SpaceBetween, verticalAlignment = Alignment.CenterVertically) {
                        Column { Row(verticalAlignment = Alignment.CenterVertically) { Icon(Icons.Default.AutoAwesome, null, tint = ZenGreenPrimary); Spacer(modifier = Modifier.width(8.dp)); Text("AI 智能解析", style = TextStyle(brush = flowBrush, fontWeight = FontWeight.Bold, fontSize = 18.sp)) } }
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            if (!isLoading && content.isNotBlank()) IconButton(onClick = onRefresh) { Icon(Icons.Default.Refresh, null, tint = ZenGreenPrimary) }
                            IconButton(onClick = onDismiss) { Icon(Icons.Default.Close, null, tint = TextSecondary) }
                        }
                    }
                    Divider(color = Color.Black.copy(0.05f))
                    Box(modifier = Modifier.weight(1f).fillMaxWidth().padding(20.dp), contentAlignment = Alignment.TopStart) {
                        if (content.isBlank() && isLoading) { Column(modifier = Modifier.align(Alignment.Center), horizontalAlignment = Alignment.CenterHorizontally) { CircularProgressIndicator(color = ZenGreenPrimary); Spacer(modifier = Modifier.height(16.dp)); Text("AI 正在思考中...", color = TextSecondary) } }
                        else { Column(modifier = Modifier.verticalScroll(rememberScrollState())) { MarkdownText(markdown = content, color = TextPrimary, fontSize = 16.sp, lineHeight = 28.sp); if (isLoading) Text("▌", color = ZenGreenPrimary, modifier = Modifier.padding(top = 4.dp)) } }
                    }
                }
            }
        }
    }
}

// [组件] 弱点卡片
@Composable
fun WeaknessCardV2(title: String, content: String, index: Int, total: Int) {
    Card(colors = CardDefaults.cardColors(containerColor = Color.White), elevation = CardDefaults.cardElevation(4.dp), shape = RoundedCornerShape(20.dp), modifier = Modifier.fillMaxHeight(0.98f).fillMaxWidth()) {
        Column(modifier = Modifier.fillMaxSize()) {
            Box(modifier = Modifier.fillMaxWidth().background(Brush.verticalGradient(listOf(ZenGreenPrimary.copy(alpha = 0.15f), Color.White))).padding(20.dp)) {
                Row(verticalAlignment = Alignment.Top) {
                    Surface(color = ZenGreenPrimary, shape = CircleShape, modifier = Modifier.size(28.dp)) { Box(contentAlignment = Alignment.Center) { Text(text = "$index", color = Color.White, fontWeight = FontWeight.Bold, fontSize = 14.sp) } }
                    Spacer(modifier = Modifier.width(12.dp))
                    Text(text = title, style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.ExtraBold, color = ZenDark, lineHeight = 32.sp)
                }
            }
            Divider(color = Color(0xFFF1F5F9))
            Column(modifier = Modifier.weight(1f).verticalScroll(rememberScrollState()).padding(24.dp)) { MarkdownText(markdown = content, color = TextPrimary, fontSize = 16.sp, lineHeight = 30.sp) }
            Box(modifier = Modifier.fillMaxWidth().height(8.dp).background(ZenGreenPrimary.copy(alpha = 0.5f)))
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\screens\OnlineSearchScreen.kt ---
```kt
package com.example.killquestion.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.CloudDownload
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.killquestion.data.model.Question
import com.example.killquestion.data.remote.SimpleAiClient
import com.example.killquestion.data.repository.QuestionRepository
import com.example.killquestion.ui.components.BouncyButton
import com.example.killquestion.ui.theme.*
import kotlinx.coroutines.launch

@Composable
fun OnlineSearchScreen(
    onBack: () -> Unit,
    onQuizStart: (String, List<Question>) -> Unit
) {
    var keyword by remember { mutableStateOf("") }
    var countStr by remember { mutableStateOf("10") }
    var isLoading by remember { mutableStateOf(false) }
    var errorMsg by remember { mutableStateOf<String?>(null) }
    val scope = rememberCoroutineScope()

    fun startSearch() {
        if (keyword.isBlank()) return
        val count = countStr.toIntOrNull() ?: 10

        isLoading = true
        errorMsg = null

        scope.launch {
            val questions = SimpleAiClient.generateOnlineQuestions(keyword, count)
            if (questions.isNotEmpty()) {
                QuestionRepository.addDynamicQuestions(questions)
                isLoading = false
                onQuizStart("搜索: $keyword", questions)
            } else {
                isLoading = false
                errorMsg = "生成失败，请换个关键词试试"
            }
        }
    }

    Scaffold(
        topBar = {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .statusBarsPadding()
                    .padding(16.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                IconButton(
                    onClick = onBack,
                    modifier = Modifier.background(Color.White, CircleShape)
                ) {
                    Icon(Icons.AutoMirrored.Filled.ArrowBack, null, tint = TextPrimary)
                }
                Spacer(modifier = Modifier.width(16.dp))
                Text("联网智能刷题", style = MaterialTheme.typography.titleLarge, fontWeight = FontWeight.Bold, color = ZenDark)
            }
        },
        containerColor = ZenBackgroundStart
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Center
        ) {
            Icon(
                imageVector = Icons.Default.CloudDownload,
                contentDescription = null,
                modifier = Modifier.size(80.dp),
                tint = ZenGreenPrimary.copy(alpha = 0.8f)
            )
            Spacer(modifier = Modifier.height(32.dp))

            Text(
                "输入考点，AI 为你出题",
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold,
                color = ZenDark
            )
            Text(
                "实时生成 · 自动收录 · 无限题库",
                style = MaterialTheme.typography.bodyMedium,
                color = TextSecondary,
                modifier = Modifier.padding(top = 8.dp, bottom = 32.dp)
            )

            // --- 1. 关键词输入区域 ---
            Column(modifier = Modifier.fillMaxWidth()) {
                // 标题在框外
                Text("考点关键词", style = MaterialTheme.typography.labelMedium, color = TextPrimary)
                Spacer(modifier = Modifier.height(8.dp))

                OutlinedTextField(
                    value = keyword,
                    onValueChange = { keyword = it },
                    placeholder = { Text("例如：太阳病、桂枝汤") }, // 提示语在框内
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(16.dp),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = ZenGreenPrimary,
                        unfocusedBorderColor = Color.Transparent,
                        focusedContainerColor = Color.White,
                        unfocusedContainerColor = Color.White
                    ),
                    singleLine = true
                )
            }

            Spacer(modifier = Modifier.height(20.dp))

            // --- 2. 数量输入区域 ---
            Column(modifier = Modifier.fillMaxWidth()) {
                // 标题在框外
                Text("生成数量", style = MaterialTheme.typography.labelMedium, color = TextPrimary)
                Spacer(modifier = Modifier.height(8.dp))

                OutlinedTextField(
                    value = countStr,
                    onValueChange = { if (it.all { char -> char.isDigit() }) countStr = it },
                    placeholder = { Text("默认为 10") }, // 提示语
                    keyboardOptions = KeyboardOptions(keyboardType = KeyboardType.Number),
                    modifier = Modifier.fillMaxWidth(),
                    shape = RoundedCornerShape(16.dp),
                    colors = OutlinedTextFieldDefaults.colors(
                        focusedBorderColor = ZenGreenPrimary,
                        unfocusedBorderColor = Color.Transparent,
                        focusedContainerColor = Color.White,
                        unfocusedContainerColor = Color.White
                    ),
                    singleLine = true
                )
            }

            Spacer(modifier = Modifier.height(8.dp))

            Text(
                text = "注：题目数量越多，AI 生成时间越长，请耐心等待。",
                style = MaterialTheme.typography.labelSmall,
                color = TextSecondary.copy(alpha = 0.8f)
            )

            Spacer(modifier = Modifier.height(8.dp))
            if (errorMsg != null) {
                Text(errorMsg!!, color = ColorMistake, fontSize = 14.sp)
            }
            Spacer(modifier = Modifier.height(24.dp))

            BouncyButton(
                onClick = { startSearch() },
                modifier = Modifier.fillMaxWidth().height(56.dp)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(
                            if (isLoading) Color.Gray else ZenGreenPrimary,
                            RoundedCornerShape(16.dp)
                        ),
                    contentAlignment = Alignment.Center
                ) {
                    if (isLoading) {
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            CircularProgressIndicator(color = Color.White, modifier = Modifier.size(20.dp))
                            Spacer(modifier = Modifier.width(12.dp))
                            Text("AI 正在出题中...", color = Color.White)
                        }
                    } else {
                        Text("开始生成题目", color = Color.White, fontSize = 18.sp, fontWeight = FontWeight.Bold)
                    }
                }
            }
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\screens\QuizScreen.kt ---
```kt
package com.example.killquestion.ui.screens

import androidx.compose.animation.animateColorAsState
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.*
import androidx.compose.material.icons.outlined.StarBorder
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.scale
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.killquestion.data.local.MistakeManager
import com.example.killquestion.data.local.ProgressManager
import com.example.killquestion.data.model.Option
import com.example.killquestion.data.model.Question
import com.example.killquestion.data.model.QuestionType
import com.example.killquestion.data.model.QuizContext
import com.example.killquestion.data.remote.SimpleAiClient
import com.example.killquestion.ui.components.BouncyButton
import com.example.killquestion.ui.components.GlassyCard
import com.example.killquestion.ui.components.TypeCapsule
import com.example.killquestion.ui.dialogs.AiResponseDialog
import com.example.killquestion.ui.dialogs.JumpDialog
import com.example.killquestion.ui.theme.*
import kotlinx.coroutines.launch

@Composable
fun QuizScreen(context: QuizContext, onBack: () -> Unit) {
    val questions = context.questions
    val initialIndex = remember {
        if (context.isMistakeMode) 0
        else {
            val idx = questions.indexOfFirst { !ProgressManager.isCompleted(it.id) }
            if (idx == -1) 0 else idx
        }
    }

    var currentIndex by remember { mutableStateOf(initialIndex) }
    var showAnswer by remember { mutableStateOf(false) }
    var selectedLabels by remember { mutableStateOf(setOf<String>()) }
    var showJumpDialog by remember { mutableStateOf(false) }

    val currentQ = if (questions.isNotEmpty()) questions[currentIndex] else return
    val uiType = currentQ.getUiType()

    val mistakeTrigger = MistakeManager.mistakeChangeTrigger
    val isMistake = remember(currentQ.id, mistakeTrigger) { MistakeManager.isMistake(currentQ.id) }
    val isLast = currentIndex == questions.size - 1

    // AI 相关状态
    var showAiDialog by remember { mutableStateOf(false) }
    var aiResponseText by remember { mutableStateOf("") } // [修改] 用于显示累积的文本
    var aiLoading by remember { mutableStateOf(false) } // 这里的 loading 含义变为“正在生成中”

    // 缓存每题的完整回复
    val aiCache = remember { mutableStateMapOf<String, String>() }

    val scope = rememberCoroutineScope()

    LaunchedEffect(currentIndex) {
        showAnswer = false
        selectedLabels = emptySet()
    }

    fun handleSubmit() {
        showAnswer = true
        if (!context.isMistakeMode) {
            ProgressManager.markCompleted(currentQ.id)
        }
        val userAns = selectedLabels.sorted().joinToString("")
        val realAns = currentQ.getRealAnswer()
        val isCorrect = userAns == realAns

        if (uiType in listOf(QuestionType.SINGLE_CHOICE, QuestionType.MULTI_CHOICE, QuestionType.TRUE_FALSE)) {
            if (!isCorrect) {
                MistakeManager.addMistake(currentQ.id)
            } else if (context.isMistakeMode) {
                MistakeManager.removeMistake(currentQ.id)
            }
        }
    }

    fun handleNavigation(isNext: Boolean) {
        showAnswer = false
        selectedLabels = emptySet()
        if (isNext && !isLast) currentIndex++
        else if (!isNext && currentIndex > 0) currentIndex--
    }

    if (showJumpDialog) {
        JumpDialog(
            totalCount = questions.size,
            currentIndex = currentIndex,
            onDismiss = { showJumpDialog = false },
            onJump = { index ->
                showAnswer = false
                selectedLabels = emptySet()
                currentIndex = index
                showJumpDialog = false
            }
        )
    }

    // [修改] 流式请求处理
    fun handleAskAi(forceRefresh: Boolean = false) {
        showAiDialog = true

        // 1. 如果有缓存且不强制刷新，直接显示缓存
        if (!forceRefresh && aiCache.containsKey(currentQ.id)) {
            aiResponseText = aiCache[currentQ.id] ?: ""
            aiLoading = false
            return
        }

        // 2. 开始新请求
        aiLoading = true
        aiResponseText = "" // 清空当前显示
        if (forceRefresh) {
            aiCache.remove(currentQ.id)
        }

        scope.launch {
            // 调用流式接口
            SimpleAiClient.askAiStream(
                question = currentQ.content,
                answer = currentQ.getRealAnswer(),
                fullAnalysis = currentQ.analysis
            ).collect { chunk ->
                // 每收到一个片段，就追加到文本中
                aiResponseText += chunk
            }

            // 收集完毕
            aiCache[currentQ.id] = aiResponseText
            aiLoading = false
        }
    }

    if (showAiDialog) {
        AiResponseDialog(
            content = aiResponseText, // [关键] 这里传入的是实时变化的文本
            isLoading = aiLoading,    // 只要流还在继续，loading 就是 true
            onDismiss = { showAiDialog = false },
            onRefresh = { handleAskAi(forceRefresh = true) }
        )
    }

    val accuracyStr = remember(questions, MistakeManager.mistakeChangeTrigger, showAnswer, currentIndex) {
        val answeredList = questions.filter { ProgressManager.isCompleted(it.id) }
        val totalAnswered = answeredList.size
        if (totalAnswered == 0) "0%" else {
            val errorCount = answeredList.count { MistakeManager.isMistake(it.id) }
            val correctCount = totalAnswered - errorCount
            val percent = (correctCount.toFloat() / totalAnswered * 100).toInt()
            "$percent%"
        }
    }

    Scaffold(
        topBar = {
            QuizTopBar(
                title = context.title,
                current = currentIndex + 1,
                total = questions.size,
                accuracy = accuracyStr,
                onBack = onBack,
                onJumpRequest = { showJumpDialog = true },
                onAiRequest = { handleAskAi(forceRefresh = false) }
            )
        },
        bottomBar = {
            QuizBottomBar(
                showAnswer = showAnswer,
                canSubmit = selectedLabels.isNotEmpty() || uiType == QuestionType.FILL_BLANK || uiType == QuestionType.ESSAY,
                isLast = isLast,
                isMistake = isMistake,
                onToggleMistake = { MistakeManager.toggleMistake(currentQ.id) },
                onSubmit = { handleSubmit() },
                onNext = { handleNavigation(true) },
                onPrev = { handleNavigation(false) }
            )
        },
        containerColor = Color.Transparent
    ) { padding ->
        Column(
            modifier = Modifier
                .padding(padding)
                .fillMaxSize()
                .verticalScroll(rememberScrollState())
                .padding(horizontal = 24.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.padding(top = 20.dp, bottom = 16.dp)
            ) {
                TypeCapsule(text = currentQ.category, color = ZenGreenPrimary)
                if (context.isMistakeMode) {
                    Spacer(modifier = Modifier.width(8.dp))
                    TypeCapsule(text = "错题复习", color = ColorMistake)
                }
            }

            Text(
                text = currentQ.content,
                style = MaterialTheme.typography.headlineSmall,
                color = TextPrimary,
                lineHeight = 36.sp,
                fontWeight = FontWeight.Medium
            )

            Spacer(modifier = Modifier.height(32.dp))

            when (uiType) {
                QuestionType.SINGLE_CHOICE, QuestionType.TRUE_FALSE, QuestionType.MULTI_CHOICE -> {
                    OptionList(
                        options = currentQ.options,
                        selectedLabels = selectedLabels,
                        showAnswer = showAnswer,
                        correctAnswer = currentQ.getRealAnswer(),
                        onSelect = { label ->
                            if (!showAnswer) {
                                selectedLabels = if (uiType == QuestionType.MULTI_CHOICE) {
                                    if (selectedLabels.contains(label)) selectedLabels - label else selectedLabels + label
                                } else {
                                    setOf(label)
                                }
                            }
                        }
                    )
                }
                else -> {
                    SubjectiveAnswerCard(showAnswer) { handleSubmit() }
                }
            }

            if (showAnswer) {
                Spacer(modifier = Modifier.height(32.dp))
                AnalysisCard(currentQ)
                Spacer(modifier = Modifier.height(100.dp))
            } else if (!context.isMistakeMode && ProgressManager.isCompleted(questions.last().id) && isLast && showAnswer) {
                CompletionMessage()
            }
        }
    }
}

@Composable
fun QuizTopBar(
    title: String,
    current: Int,
    total: Int,
    accuracy: String,
    onBack: () -> Unit,
    onJumpRequest: () -> Unit,
    onAiRequest: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = 20.dp, vertical = 16.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        IconButton(
            onClick = onBack,
            modifier = Modifier.background(Color.White.copy(alpha = 0.8f), CircleShape)
        ) {
            Icon(Icons.AutoMirrored.Filled.ArrowBack, null, tint = TextPrimary)
        }

        Spacer(modifier = Modifier.width(16.dp))

        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = title,
                style = MaterialTheme.typography.titleSmall,
                fontWeight = FontWeight.Bold,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
            Spacer(modifier = Modifier.height(6.dp))
            Box(
                modifier = Modifier
                    .fillMaxWidth(0.6f)
                    .height(6.dp)
                    .clip(RoundedCornerShape(3.dp))
                    .background(Color.Black.copy(0.05f))
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth(current.toFloat() / total)
                        .fillMaxHeight()
                        .background(ZenGreenPrimary)
                )
            }
        }

        Row(verticalAlignment = Alignment.CenterVertically) {
            Surface(
                shape = RoundedCornerShape(12.dp),
                color = Color(0xFFE8F5E9),
                modifier = Modifier.height(32.dp),
                border = BorderStroke(1.dp, ZenGreenPrimary.copy(alpha = 0.1f))
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    modifier = Modifier.padding(horizontal = 10.dp)
                ) {
                    Icon(
                        Icons.Default.CheckCircleOutline,
                        contentDescription = null,
                        tint = ZenGreenPrimary,
                        modifier = Modifier.size(14.dp)
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = accuracy,
                        style = MaterialTheme.typography.labelSmall,
                        fontWeight = FontWeight.Bold,
                        color = ZenGreenPrimary
                    )
                }
            }

            Spacer(modifier = Modifier.width(8.dp))

            Surface(
                shape = CircleShape,
                color = ZenGreenPrimary.copy(alpha = 0.1f),
                modifier = Modifier
                    .size(36.dp)
                    .clickable(onClick = onAiRequest)
            ) {
                Box(contentAlignment = Alignment.Center) {
                    Icon(
                        Icons.Default.AutoAwesome,
                        contentDescription = "Ask AI",
                        tint = ZenGreenPrimary,
                        modifier = Modifier.size(20.dp)
                    )
                }
            }

            Spacer(modifier = Modifier.width(8.dp))

            Surface(
                shape = RoundedCornerShape(20.dp),
                color = Color.White.copy(alpha = 0.8f),
                shadowElevation = 1.dp,
                modifier = Modifier.clickable(onClick = onJumpRequest)
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    modifier = Modifier.padding(horizontal = 10.dp, vertical = 6.dp)
                ) {
                    Text(
                        "$current/$total",
                        style = MaterialTheme.typography.labelSmall,
                        fontWeight = FontWeight.Bold,
                        color = TextPrimary
                    )
                }
            }
        }
    }
}

@Composable
fun QuizBottomBar(
    showAnswer: Boolean,
    canSubmit: Boolean,
    isLast: Boolean,
    isMistake: Boolean,
    onToggleMistake: () -> Unit,
    onSubmit: () -> Unit,
    onNext: () -> Unit,
    onPrev: () -> Unit
) {
    Surface(
        shadowElevation = 24.dp,
        color = Color.White,
        shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .navigationBarsPadding()
                .padding(20.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            IconButton(
                onClick = onPrev,
                modifier = Modifier
                    .size(50.dp)
                    .background(Color(0xFFF1F5F9), CircleShape)
            ) {
                Icon(Icons.AutoMirrored.Filled.ArrowBack, null, tint = TextSecondary)
            }

            Spacer(modifier = Modifier.width(12.dp))

            IconButton(
                onClick = onToggleMistake,
                modifier = Modifier
                    .size(50.dp)
                    .background(if (isMistake) ColorStar.copy(alpha = 0.1f) else Color(0xFFF1F5F9), CircleShape)
            ) {
                Icon(
                    if (isMistake) Icons.Filled.Star else Icons.Outlined.StarBorder,
                    null,
                    tint = if (isMistake) ColorStar else TextSecondary,
                    modifier = Modifier.scale(if (isMistake) 1.1f else 1f)
                )
            }

            Spacer(modifier = Modifier.width(16.dp))

            BouncyButton(
                onClick = { if (showAnswer) onNext() else onSubmit() },
                modifier = Modifier.weight(1f)
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(54.dp)
                        .clip(RoundedCornerShape(18.dp))
                        .background(if (canSubmit || showAnswer) ZenGreenPrimary else Color(0xFFE2E8F0)),
                    contentAlignment = Alignment.Center
                ) {
                    Text(
                        text = if (showAnswer) (if (isLast) "完成本章" else "下一题") else "提交答案",
                        fontSize = 17.sp,
                        fontWeight = FontWeight.Bold,
                        color = if (canSubmit || showAnswer) Color.White else TextSecondary
                    )
                }
            }
        }
    }
}

@Composable
fun OptionList(
    options: List<Option>,
    selectedLabels: Set<String>,
    showAnswer: Boolean,
    correctAnswer: String,
    onSelect: (String) -> Unit
) {
    Column(verticalArrangement = Arrangement.spacedBy(14.dp)) {
        options.forEach { option ->
            key(option.label) {
                val isSelected = selectedLabels.contains(option.label)
                val isCorrectOption = correctAnswer.contains(option.label)
                val LightGreenBg = Color(0xFFE8F5E9)

                val containerColor = when {
                    showAnswer && isCorrectOption -> ColorCorrect.copy(alpha = 0.1f)
                    showAnswer && isSelected && !isCorrectOption -> ColorWrong.copy(alpha = 0.1f)
                    isSelected -> LightGreenBg
                    else -> ZenSurface
                }

                val contentColor = when {
                    showAnswer && isCorrectOption -> ColorCorrect
                    showAnswer && isSelected && !isCorrectOption -> ColorWrong
                    isSelected -> ZenGreenPrimary
                    else -> TextSecondary
                }

                val textColor = when {
                    isSelected -> ZenDark
                    else -> TextPrimary
                }

                val animatedFill by animateColorAsState(containerColor, label = "fill")

                BouncyButton(onClick = { if(!showAnswer) onSelect(option.label) }) {
                    Surface(
                        modifier = Modifier.fillMaxWidth(),
                        shape = RoundedCornerShape(16.dp),
                        color = animatedFill,
                        border = null,
                        shadowElevation = 0.dp
                    ) {
                        Row(
                            modifier = Modifier.padding(16.dp),
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Box(
                                modifier = Modifier
                                    .size(32.dp)
                                    .clip(CircleShape)
                                    .background(
                                        if (isSelected && !showAnswer) ZenGreenPrimary.copy(alpha = 0.2f)
                                        else if (containerColor != ZenSurface) contentColor.copy(alpha = 0.1f)
                                        else Color(0xFFF3F4F6)
                                    ),
                                contentAlignment = Alignment.Center
                            ) {
                                Text(
                                    text = option.label,
                                    fontWeight = FontWeight.Bold,
                                    color = if (isSelected && !showAnswer) ZenGreenPrimary else if (containerColor != ZenSurface) contentColor else TextSecondary
                                )
                            }

                            Spacer(modifier = Modifier.width(16.dp))

                            Text(
                                text = option.text,
                                style = MaterialTheme.typography.bodyLarge,
                                color = if (isSelected && !showAnswer) textColor else TextPrimary,
                                modifier = Modifier.weight(1f),
                                lineHeight = 24.sp
                            )

                            if (showAnswer) {
                                if (isCorrectOption) Icon(Icons.Default.CheckCircle, null, tint = ColorCorrect, modifier = Modifier.size(24.dp))
                                else if (isSelected) Icon(Icons.Default.Cancel, null, tint = ColorWrong, modifier = Modifier.size(24.dp))
                            }
                        }
                    }
                }
            }
        }
    }
}

@Composable
fun SubjectiveAnswerCard(showAnswer: Boolean, onClick: () -> Unit) {
    if (!showAnswer) {
        BouncyButton(onClick = onClick) {
            Surface(
                modifier = Modifier.fillMaxWidth().height(100.dp),
                shape = RoundedCornerShape(16.dp),
                color = Color.White,
                shadowElevation = 1.dp,
                border = BorderStroke(1.dp, ZenGreenPrimary.copy(alpha = 0.2f))
            ) {
                Column(
                    modifier = Modifier.fillMaxSize(),
                    horizontalAlignment = Alignment.CenterHorizontally,
                    verticalArrangement = Arrangement.Center
                ) {
                    Icon(Icons.Default.TouchApp, null, tint = ZenGreenPrimary, modifier = Modifier.size(28.dp))
                    Spacer(modifier = Modifier.height(8.dp))
                    Text("点击查看参考答案", color = ZenGreenPrimary, fontWeight = FontWeight.Bold)
                }
            }
        }
    }
}

@Composable
fun AnalysisCard(question: Question) {
    val uiType = question.getUiType()
    val isTrueFalse = uiType == QuestionType.TRUE_FALSE
    val realAns = if (isTrueFalse) {
        if (question.getRealAnswer() == "A") "正确" else "错误"
    } else {
        question.getRealAnswer()
    }
    val fullExplanation = question.getFullExplanation()
    val isObjective = uiType in listOf(QuestionType.SINGLE_CHOICE, QuestionType.MULTI_CHOICE, QuestionType.TRUE_FALSE, QuestionType.FILL_BLANK)
    val ansFontSize = if (isObjective) MaterialTheme.typography.headlineMedium.fontSize else MaterialTheme.typography.bodyLarge.fontSize

    GlassyCard(
        backgroundColor = Color(0xFFF0FDF4),
        elevation = 0.dp,
        border = null
    ) {
        Column(modifier = Modifier.padding(20.dp)) {
            Row(verticalAlignment = Alignment.CenterVertically) {
                Icon(Icons.Default.AutoAwesome, null, tint = ZenGreenPrimary, modifier = Modifier.size(20.dp))
                Spacer(modifier = Modifier.width(8.dp))
                Text("解析", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = ZenGreenPrimary)
            }

            Spacer(modifier = Modifier.height(16.dp))

            Row(verticalAlignment = Alignment.Bottom) {
                Text("正确答案", style = MaterialTheme.typography.labelMedium, color = TextSecondary)
                Spacer(modifier = Modifier.width(8.dp))
                Text(
                    text = realAns,
                    fontSize = ansFontSize,
                    fontWeight = FontWeight.Bold,
                    color = ColorCorrect
                )
            }

            if (fullExplanation.isNotBlank()) {
                Spacer(modifier = Modifier.height(16.dp))
                Divider(color = ZenGreenPrimary.copy(alpha = 0.1f))
                Spacer(modifier = Modifier.height(16.dp))
                Text(
                    text = fullExplanation,
                    style = MaterialTheme.typography.bodyMedium,
                    color = TextPrimary,
                    lineHeight = 34.sp
                )
            }
        }
    }
}

@Composable
fun CompletionMessage() {
    Column(
        modifier = Modifier.fillMaxWidth().padding(top = 32.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Icon(Icons.Default.EmojiEvents, null, tint = ColorStar, modifier = Modifier.size(48.dp))
        Spacer(modifier = Modifier.height(8.dp))
        Text(
            "恭喜！本章节已全部完成。",
            color = ZenGreenPrimary,
            fontWeight = FontWeight.Bold,
            style = MaterialTheme.typography.titleMedium
        )
        Spacer(modifier = Modifier.height(100.dp))
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\screens\SelectionScreen.kt ---
```kt
package com.example.killquestion.ui.screens

import androidx.activity.compose.BackHandler
import androidx.appcompat.app.AlertDialog
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.itemsIndexed
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.filled.Abc
import androidx.compose.material.icons.filled.AutoStories
import androidx.compose.material.icons.filled.Bookmarks
import androidx.compose.material.icons.filled.Category
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Cloud
import androidx.compose.material.icons.filled.History
import androidx.compose.material.icons.filled.School
import androidx.compose.material3.AlertDialog
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.vector.ImageVector
import androidx.compose.ui.platform.LocalConfiguration
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.killquestion.data.repository.QuestionRepository
import com.example.killquestion.ui.components.BouncyButton
import com.example.killquestion.ui.components.SmallIconButton
import com.example.killquestion.ui.theme.*

// 20种渐变色板 (保持不变)
val CardGradients = listOf(
    Brush.linearGradient(listOf(Color(0xFFE0F2F1), Color(0xFFB2DFDB))),
    Brush.linearGradient(listOf(Color(0xFFE3F2FD), Color(0xFFBBDEFB))),
    Brush.linearGradient(listOf(Color(0xFFF3E5F5), Color(0xFFE1BEE7))),
    Brush.linearGradient(listOf(Color(0xFFFFF3E0), Color(0xFFFFE0B2))),
    Brush.linearGradient(listOf(Color(0xFFFAFAFA), Color(0xFFEEEEEE))),
    Brush.linearGradient(listOf(Color(0xFFFCE4EC), Color(0xFFF8BBD0))),
    Brush.linearGradient(listOf(Color(0xFFF9FBE7), Color(0xFFDCEDC8))),
    Brush.linearGradient(listOf(Color(0xFFE1F5FE), Color(0xFF81D4FA))),
    Brush.linearGradient(listOf(Color(0xFFFFFDE7), Color(0xFFFFF9C4))),
    Brush.linearGradient(listOf(Color(0xFFE8EAF6), Color(0xFFC5CAE9))),
    Brush.linearGradient(listOf(Color(0xFFFFEBEE), Color(0xFFFFCDD2))),
    Brush.linearGradient(listOf(Color(0xFFE0F7FA), Color(0xFF80DEEA))),
    Brush.linearGradient(listOf(Color(0xFFEFEBE9), Color(0xFFD7CCC8))),
    Brush.linearGradient(listOf(Color(0xFFECEFF1), Color(0xFFCFD8DC))),
    Brush.linearGradient(listOf(Color(0xFFE8F5E9), Color(0xFFA5D6A7))),
    Brush.linearGradient(listOf(Color(0xFFEDE7F6), Color(0xFFB39DDB))),
    Brush.linearGradient(listOf(Color(0xFFFFF8E1), Color(0xFFFFECB3))),
    Brush.linearGradient(listOf(Color(0xFFE0F7FA), Color(0xFF4DD0E1))),
    Brush.linearGradient(listOf(Color(0xFFF8BBD0), Color(0xFFF48FB1))),
    Brush.linearGradient(listOf(Color(0xFFF1F8E9), Color(0xFFAED581)))
)

@Composable
fun SelectionScreen(title: String, subtitle: String, items: List<String>, onBack: () -> Unit, onSelect: (String) -> Unit) {
    // 强制刷新 UI 的状态 (当删除元素时触发)
    var refreshTrigger by remember { mutableStateOf(0) }

    val (onlineItems, offlineItems) = remember(items, refreshTrigger) {
        items.partition { it.startsWith("联网搜索") }
    }

    var isInOnlineFolder by remember { mutableStateOf(false) }

    // [新增] 删除确认弹窗状态
    var showDeleteDialog by remember { mutableStateOf(false) }
    var deleteTarget by remember { mutableStateOf<String?>(null) }

    BackHandler(enabled = isInOnlineFolder) {
        isInOnlineFolder = false
    }

    // [新增] 弹窗 UI
    if (showDeleteDialog && deleteTarget != null) {
        AlertDialog(
            onDismissRequest = { showDeleteDialog = false },
            title = { Text("确认删除？", fontWeight = FontWeight.Bold) },
            text = { Text("删除后，该关键词下的所有题目将从本地清除，且无法恢复。") },
            confirmButton = {
                TextButton(
                    onClick = {
                        // 执行删除
                        QuestionRepository.deleteChapter(deleteTarget!!)
                        refreshTrigger++
                        showDeleteDialog = false
                    }
                ) { Text("确认删除", color = ColorMistake) }
            },
            dismissButton = {
                TextButton(onClick = { showDeleteDialog = false }) { Text("取消", color = TextSecondary) }
            },
            containerColor = Color.White
        )
    }

    // [计算高度逻辑]
    // 目标：除以去顶部栏，剩下的空间 2列 x 5行 = 10个卡片
    // 获取屏幕高度
    val configuration = LocalConfiguration.current
    val screenHeight = configuration.screenHeightDp.dp
    // 预估顶部栏+Padding的高度 (80dp 顶部 + 20dp 顶部padding + 10dp 底部padding) ≈ 110dp
    // 加上 Grid 的间距 (4 * 16dp)
    // 简单算法：可用高度 / 5
    val availableHeight = screenHeight - 120.dp
    val dynamicCardHeight = (availableHeight / 5) - 16.dp // 减去间距
    // 限制一个最小高度，防止屏幕太矮时卡片压扁
    val finalCardHeight = maxOf(100.dp, dynamicCardHeight)

    Column(modifier = Modifier.fillMaxSize()) {
        // 顶部栏
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .statusBarsPadding()
                .padding(horizontal = 16.dp, vertical = 20.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            SmallIconButton(
                icon = Icons.AutoMirrored.Filled.ArrowBack,
                onClick = {
                    if (isInOnlineFolder) isInOnlineFolder = false else onBack()
                }
            )
            Spacer(modifier = Modifier.width(16.dp))
            Column {
                Text(
                    text = if (isInOnlineFolder) "联网刷题记录" else title,
                    style = MaterialTheme.typography.titleLarge,
                    fontWeight = FontWeight.Bold,
                    color = ZenDark
                )
                Text(
                    text = if (isInOnlineFolder) "点击进入 / 点击右上角删除" else subtitle,
                    style = MaterialTheme.typography.bodySmall,
                    color = TextSecondary
                )
            }
        }

        // 列表区域
        LazyVerticalGrid(
            columns = GridCells.Fixed(2),
            contentPadding = PaddingValues(horizontal = 20.dp, vertical = 10.dp),
            horizontalArrangement = Arrangement.spacedBy(16.dp),
            verticalArrangement = Arrangement.spacedBy(16.dp),
            modifier = Modifier.weight(1f)
        ) {
            if (isInOnlineFolder) {
                // --- 二级页面 ---
                itemsIndexed(onlineItems) { index, item ->
                    val gradient = CardGradients[index % CardGradients.size]
                    val displayName = item.removePrefix("联网搜索:").trim()

                    ModernSelectionTile(
                        text = displayName,
                        index = index + 1,
                        gradient = gradient,
                        icon = Icons.Default.Cloud,
                        height = finalCardHeight,
                        onDelete = {
                            // [修改]：点击只弹出确认框，不直接删除
                            deleteTarget = item
                            showDeleteDialog = true
                        },
                        onClick = { onSelect(item) }
                    )
                }

                if (onlineItems.isEmpty()) {
                    item {
                        Text(
                            "暂无联网刷题记录\n请去首页进行联网刷题",
                            modifier = Modifier.padding(20.dp),
                            color = TextSecondary
                        )
                    }
                }

            } else {
                // --- 一级页面：普通章节 ---
                itemsIndexed(offlineItems) { index, item ->
                    val gradient = CardGradients[index % CardGradients.size]
                    val icon = when (index % 6) {
                        0 -> Icons.Default.AutoStories
                        1 -> Icons.Default.Category
                        2 -> Icons.Default.Bookmarks
                        3 -> Icons.Default.School
                        4 -> Icons.Default.Abc
                        else -> Icons.Default.AutoStories
                    }

                    ModernSelectionTile(
                        text = item,
                        index = index + 1,
                        gradient = gradient,
                        icon = icon,
                        height = finalCardHeight, // [应用动态高度]
                        onClick = { onSelect(item) }
                    )
                }

                // 文件夹入口 (放在最后)
                item {
                    ModernSelectionTile(
                        text = "联网刷题记录",
                        index = offlineItems.size + 1,
                        gradient = Brush.linearGradient(listOf(Color(0xFF8B5CF6), Color(0xFFDDD6FE))),
                        icon = Icons.Default.History,
                        height = finalCardHeight, // [应用动态高度]
                        onClick = { isInOnlineFolder = true }
                    )
                }
            }
        }
    }
}

@Composable
fun ModernSelectionTile(
    text: String,
    index: Int,
    gradient: Brush,
    icon: ImageVector,
    height: Dp,
    onDelete: (() -> Unit)? = null, // [新增] 删除回调，为空时不显示删除按钮
    onClick: () -> Unit
) {
    // 这是一个小技巧：如果处于 BouncyButton 内部，点击事件会被父级捕获。
    // 为了让删除按钮能独立点击，我们需要把它放在 Box 的最上层，并且处理点击事件传递。

    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(height) // 使用计算出的高度
    ) {
        // 底层卡片 (负责点击跳转)
        BouncyButton(onClick = onClick, modifier = Modifier.matchParentSize()) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .clip(RoundedCornerShape(24.dp))
                    .background(gradient)
            ) {
                // 背景图标
                Icon(
                    imageVector = icon,
                    contentDescription = null,
                    tint = Color.White.copy(alpha = 0.5f),
                    modifier = Modifier
                        .size(height * 0.6f) // 图标大小随卡片高度缩放
                        .align(Alignment.BottomEnd)
                        .offset(x = 10.dp, y = 10.dp)
                )

                // 文字内容
                Column(
                    modifier = Modifier
                        .fillMaxSize()
                        .padding(20.dp),
                    verticalArrangement = Arrangement.SpaceBetween
                ) {
                    Box(
                        modifier = Modifier
                            .background(Color.White.copy(alpha = 0.6f), CircleShape)
                            .padding(horizontal = 8.dp, vertical = 4.dp)
                    ) {
                        Text(
                            text = String.format("%02d", index),
                            style = MaterialTheme.typography.labelSmall,
                            fontWeight = FontWeight.Bold,
                            color = TextSecondary.copy(alpha = 0.8f)
                        )
                    }

                    Text(
                        text = text,
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.ExtraBold,
                        color = ZenDark,
                        maxLines = 3,
                        lineHeight = 22.sp
                    )
                }
            }
        }

        // [新增] 删除按钮 (右上角悬浮)
        if (onDelete != null) {
            IconButton(
                onClick = onDelete,
                modifier = Modifier
                    .align(Alignment.TopEnd)
                    .padding(8.dp)
                    .size(28.dp)
                    .background(Color.White.copy(alpha = 0.3f), CircleShape)
            ) {
                Icon(
                    Icons.Default.Close,
                    contentDescription = "删除",
                    tint = Color.White,
                    modifier = Modifier.size(16.dp)
                )
            }
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\screens\StartScreen.kt ---
```kt
package com.example.killquestion.ui.screens

import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.layout.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.List
import androidx.compose.material.icons.filled.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.example.killquestion.data.local.MistakeManager
import com.example.killquestion.data.repository.QuestionRepository
import com.example.killquestion.ui.components.MenuCard
import com.example.killquestion.ui.components.SmallIconButton
import com.example.killquestion.ui.components.StatCard
import com.example.killquestion.ui.dialogs.AiImageDialog
import com.example.killquestion.ui.dialogs.EasterEggDialog
import com.example.killquestion.ui.dialogs.GuideDialog
import com.example.killquestion.ui.dialogs.SettingsDialog
import com.example.killquestion.ui.theme.*

@Composable
fun StartScreen(
    onModeSelect: (String) -> Unit,
    onWeaknessAnalysisClick: () -> Unit // [新增回调]
) {
    val trigger = MistakeManager.mistakeChangeTrigger
    val mistakeCount = remember(trigger) { MistakeManager.getAllMistakeIds().size }

    // --- 状态管理 ---
    var easterEggCount by remember { mutableIntStateOf(0) }
    var showEasterEgg by remember { mutableStateOf(false) }
    var showSettings by remember { mutableStateOf(false) }
    var showGuide by remember { mutableStateOf(false) }

    // [删除] 之前内部的 weaknessCards, showWeaknessDialog 等状态
    // [删除] 之前内部的 startWeaknessAnalysis 函数

    // --- 弹窗渲染区域 ---
    if (showEasterEgg) {
        EasterEggDialog(onDismiss = { showEasterEgg = false; easterEggCount = 0 })
    }
    if (showSettings) {
        SettingsDialog(onDismiss = { showSettings = false })
    }
    if (showGuide) {
        GuideDialog(onDismiss = { showGuide = false })
    }
    // [新增] 状态控制
    var showAiImageDialog by remember { mutableStateOf(false) }

    if (showAiImageDialog) {
        AiImageDialog(onDismiss = { showAiImageDialog = false })
    }
    // [删除] WeaknessResultDialog 的调用

    // --- 界面布局 ---
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = 24.dp),
    ) {
        Spacer(modifier = Modifier.height(48.dp))

        // --- 顶部栏 ---
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Column(modifier = Modifier.weight(1f)) {
                Text(
                    text = "伤寒论",
                    style = MaterialTheme.typography.displayMedium.copy(fontFamily = FontFamily.Serif),
                    fontWeight = FontWeight.Bold,
                    color = ZenDark
                )
                Spacer(modifier = Modifier.height(4.dp))
                Text(
                    text = "中医经典 · 刷题宝典",
                    style = MaterialTheme.typography.titleMedium,
                    color = TextSecondary,
                    letterSpacing = 2.sp,
                    fontSize = 14.sp
                )
            }

            Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                SmallIconButton(
                    icon = Icons.Default.Info,
                    onClick = { showGuide = true }
                )
                SmallIconButton(
                    icon = Icons.Default.Image, // 记得导入 Icons.Default.Image
                    onClick = { showAiImageDialog = true }
                )
                SmallIconButton(
                    icon = Icons.Default.Settings,
                    onClick = { showSettings = true }
                )
                SmallIconButton(
                    icon = Icons.Default.Psychology,
                    // [修改] 点击直接调用外部回调
                    onClick = onWeaknessAnalysisClick
                )
            }
        }

        // [修改核心]：使用一个 Column 占据中间剩余所有空间，并均匀分布内部 5 个元素
        Column(
            modifier = Modifier
                .weight(1f) // 占据中间全部空间
                .fillMaxWidth(),
            verticalArrangement = Arrangement.SpaceEvenly // 均匀分布
        ) {
            // 模块 1: 统计卡片
            Row(modifier = Modifier.fillMaxWidth(), horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                StatCard(Modifier.weight(1f), "总题量", "${QuestionRepository.getTotalCount()}", Icons.Default.LibraryBooks, ZenGreenPrimary)
                StatCard(Modifier.weight(1f), "错题数", "$mistakeCount", Icons.Default.Warning, ColorMistake)
            }

            // 模块 2: 章节刷题
            MenuCard(
                title = "章节刷题",
                subtitle = "扎实基础",
                icon = Icons.Default.MenuBook,
                gradient = MainGradient,
                onClick = { onModeSelect("CHAPTER") }
            )

            // 模块 3: 题型刷题
            MenuCard(
                title = "题型刷题",
                subtitle = "针对训练",
                icon = Icons.AutoMirrored.Filled.List,
                gradient = Brush.linearGradient(listOf(Color(0xFF457B9D), Color(0xFF1D3557))),
                onClick = { onModeSelect("TYPE") }
            )

            // 模块 4: 联网刷题
            MenuCard(
                title = "联网刷题",
                subtitle = "AI 实时出题 (无限)",
                icon = Icons.Default.CloudDownload,
                gradient = Brush.linearGradient(listOf(Color(0xFF8B5CF6), Color(0xFF6D28D9))),
                onClick = { onModeSelect("ONLINE") }
            )

            // 模块 5: 错题回顾 (重命名)
            MenuCard(
                title = "错题回顾", // [修改名字]
                subtitle = "温故知新",
                icon = Icons.Default.HistoryEdu,
                gradient = MistakeGradient,
                onClick = { if (mistakeCount > 0) onModeSelect("MISTAKE") }
            )
        }

        Text(
            text = "Designed by 邝梓濠",
            style = TextStyle(
                brush = ColorfulGradient,
                fontSize = 14.sp,
                fontWeight = FontWeight.Bold,
                fontFamily = FontFamily.Cursive
            ),
            modifier = Modifier
                .align(Alignment.CenterHorizontally)
                .padding(bottom = 16.dp)
                .clickable(
                    interactionSource = remember { MutableInteractionSource() },
                    indication = null
                ) {
                    easterEggCount++
                    if (easterEggCount >= 5) {
                        showEasterEgg = true
                    }
                }
        )
    }


}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\screens\WeaknessAnalysisScreen.kt ---
```kt
package com.example.killquestion.ui.screens

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.pager.HorizontalPager
import androidx.compose.foundation.pager.rememberPagerState
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.automirrored.filled.ArrowBack
import androidx.compose.material.icons.automirrored.filled.ArrowForward
import androidx.compose.material.icons.filled.Close
import androidx.compose.material.icons.filled.Refresh
import androidx.compose.material.icons.filled.Search
import androidx.compose.material.icons.filled.Share
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.compose.ui.window.Dialog
import com.example.killquestion.ui.components.SmallIconButton
import com.example.killquestion.ui.dialogs.WeaknessCardV2
import com.example.killquestion.ui.theme.*
import com.example.killquestion.util.PdfExportManager
import kotlinx.coroutines.launch

@Composable
fun WeaknessAnalysisScreen(
    cards: List<Pair<String, String>>,
    isLoading: Boolean,
    onBack: () -> Unit,
    onRefresh: () -> Unit
) {
    // 搜索状态
    var searchQuery by remember { mutableStateOf("") }

    // 过滤后的卡片列表
    val filteredCards = remember(cards, searchQuery) {
        if (searchQuery.isBlank()) cards
        else cards.filter {
            it.first.contains(searchQuery, ignoreCase = true) ||
                    it.second.contains(searchQuery, ignoreCase = true)
        }
    }

    // Pager 状态
    val pagerState = rememberPagerState(pageCount = { filteredCards.size })
    val scope = rememberCoroutineScope()

    // 跳转弹窗状态
    var showJumpSelector by remember { mutableStateOf(false) }

    val context = LocalContext.current

    // 快速跳转弹窗
    if (showJumpSelector) {
        Dialog(onDismissRequest = { showJumpSelector = false }) {
            Surface(
                shape = RoundedCornerShape(16.dp),
                color = Color.White,
                modifier = Modifier.height(400.dp)
            ) {
                Column(modifier = Modifier.padding(16.dp)) {
                    Text("快速跳转", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, modifier = Modifier.padding(bottom = 12.dp))
                    LazyVerticalGrid(
                        columns = GridCells.Adaptive(60.dp),
                        verticalArrangement = Arrangement.spacedBy(8.dp),
                        horizontalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        items(filteredCards.size) { index ->
                            Box(
                                modifier = Modifier
                                    .size(50.dp)
                                    .clip(RoundedCornerShape(12.dp))
                                    .background(if (pagerState.currentPage == index) ZenGreenPrimary else ZenBackgroundStart)
                                    .clickable {
                                        scope.launch { pagerState.scrollToPage(index) }
                                        showJumpSelector = false
                                    },
                                contentAlignment = Alignment.Center
                            ) {
                                Text(
                                    text = "${index + 1}",
                                    color = if (pagerState.currentPage == index) Color.White else TextPrimary,
                                    fontWeight = FontWeight.Bold
                                )
                            }
                        }
                    }
                }
            }
        }
    }

    Scaffold(
        topBar = {
            Column(modifier = Modifier.background(ZenBackgroundStart)) {
                // 顶部导航栏
                Row(
                    modifier = Modifier
                        .fillMaxWidth()
                        .statusBarsPadding()
                        .padding(horizontal = 16.dp, vertical = 12.dp),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    // [修改 1]：左侧返回按钮改用 SmallIconButton
                    SmallIconButton(
                        icon = Icons.AutoMirrored.Filled.ArrowBack,
                        onClick = onBack,
                        tint = TextPrimary
                    )

                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text("智能弱点分析", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold, color = ZenDark)
                        Text(
                            if (isLoading) "正在分析中..." else "生成 ${filteredCards.size} 张卡片",
                            style = MaterialTheme.typography.labelSmall,
                            color = TextSecondary
                        )
                    }

                    // [修改 2]：右侧按钮组改用 SmallIconButton
                    Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {

                        // 分享按钮
                        if (!isLoading && cards.isNotEmpty()) {
                            SmallIconButton(
                                icon = Icons.Default.Share,
                                onClick = { PdfExportManager.exportAndShare(context, cards) },
                                tint = ZenGreenPrimary
                            )
                        }

                        // 刷新按钮
                        SmallIconButton(
                            icon = Icons.Default.Refresh,
                            onClick = onRefresh,
                            tint = ZenGreenPrimary
                            // 注意：SmallIconButton 默认没有 enabled 属性，
                            // 如果需要禁用效果，可以在 onClick 里判断，或者给 SmallIconButton 加个 enabled 参数
                            // 这里简单处理：如果 isLoading 就不响应点击即可，视觉上不做灰色处理也行，或者保持原样
                        )
                    }
                }

                // 搜索栏
                if (!isLoading && cards.isNotEmpty()) {
                    Box(modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp)) {
                        OutlinedTextField(
                            value = searchQuery,
                            onValueChange = {
                                searchQuery = it
                                // 搜索时重置到第一页
                                scope.launch { pagerState.scrollToPage(0) }
                            },
                            placeholder = { Text("搜索知识点...", fontSize = 14.sp, color = TextSecondary.copy(0.7f)) },
                            modifier = Modifier
                                .fillMaxWidth()
                                .height(50.dp)
                                .background(Color.White, RoundedCornerShape(25.dp)), // 圆角更大
                            shape = RoundedCornerShape(25.dp),
                            singleLine = true,
                            leadingIcon = { Icon(Icons.Default.Search, null, tint = ZenGreenPrimary) },
                            colors = OutlinedTextFieldDefaults.colors(
                                focusedBorderColor = ZenGreenPrimary,
                                unfocusedBorderColor = Color.Transparent,
                                focusedContainerColor = Color.White,
                                unfocusedContainerColor = Color.White
                            )
                        )
                    }
                }
            }
        },
        containerColor = ZenBackgroundStart
    ) { padding ->

        // 内容区域
        Box(modifier = Modifier
            .fillMaxSize()
            .padding(padding)
        ) {
            if (isLoading) {
                Column(
                    modifier = Modifier.align(Alignment.Center),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    CircularProgressIndicator(color = ZenGreenPrimary, modifier = Modifier.size(48.dp))
                    Spacer(modifier = Modifier.height(24.dp))
                    Text("AI 正在梳理错题...", style = MaterialTheme.typography.titleMedium, color = TextPrimary)
                    Text("可能需要十几秒，请稍候", color = TextSecondary)
                }
            } else if (filteredCards.isEmpty()) {
                Box(modifier = Modifier.align(Alignment.Center)) {
                    Text(
                        if(searchQuery.isNotEmpty()) "未找到相关知识点" else "暂无分析结果",
                        color = TextSecondary
                    )
                }
            } else {
                Column(modifier = Modifier.fillMaxSize()) {
                    // 卡片滑动区域
                    HorizontalPager(
                        state = pagerState,
                        modifier = Modifier.weight(1f),
                        // [修改点 1]：减小左右边距，让卡片更宽
                        contentPadding = PaddingValues(horizontal = 12.dp), // 原来是 32.dp
                        // [修改点 2]：减小卡片间距
                        pageSpacing = 8.dp // 原来是 16.dp
                    ) { page ->
                        val item = filteredCards.getOrNull(page)
                        if (item != null) {
                            // [修改点 3]：稍微减小上下内边距，让卡片更高
                            Box(modifier = Modifier.padding(vertical = 8.dp)) { // 原来是 16.dp
                                WeaknessCardV2(
                                    title = item.first,
                                    content = item.second,
                                    index = page + 1,
                                    total = filteredCards.size
                                )
                            }
                        }
                    }

                    // 底部控制栏
                    Row(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp)
                            .navigationBarsPadding(),
                        horizontalArrangement = Arrangement.SpaceBetween,
                        verticalAlignment = Alignment.CenterVertically
                    ) {
                        IconButton(
                            onClick = { scope.launch { pagerState.animateScrollToPage(pagerState.currentPage - 1) } },
                            enabled = pagerState.currentPage > 0,
                            modifier = Modifier.background(Color.White, CircleShape)
                        ) {
                            Icon(Icons.AutoMirrored.Filled.ArrowBack, null, tint = if (pagerState.currentPage > 0) ZenGreenPrimary else Color.LightGray)
                        }

                        // 页码指示器 (点击弹出跳转)
                        Surface(
                            shape = RoundedCornerShape(20.dp),
                            color = ZenGreenPrimary,
                            modifier = Modifier
                                .height(40.dp)
                                .clickable { showJumpSelector = true },
                            shadowElevation = 4.dp
                        ) {
                            Box(
                                contentAlignment = Alignment.Center,
                                modifier = Modifier.padding(horizontal = 20.dp)
                            ) {
                                Text(
                                    text = "${pagerState.currentPage + 1} / ${filteredCards.size}",
                                    fontWeight = FontWeight.Bold,
                                    color = Color.White
                                )
                            }
                        }

                        IconButton(
                            onClick = { scope.launch { pagerState.animateScrollToPage(pagerState.currentPage + 1) } },
                            enabled = pagerState.currentPage < filteredCards.size - 1,
                            modifier = Modifier.background(Color.White, CircleShape)
                        ) {
                            Icon(Icons.AutoMirrored.Filled.ArrowForward, null, tint = if (pagerState.currentPage < filteredCards.size - 1) ZenGreenPrimary else Color.LightGray)
                        }
                    }
                }
            }
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\theme\Color.kt ---
```kt
package com.example.killquestion.ui.theme

import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color

// 基础色板
val ZenDark = Color(0xFF1C2321) // 深墨绿黑
val ZenGreenPrimary = Color(0xFF2D6A4F) // 祖母绿
val ZenGreenAccent = Color(0xFF52B788) // 清透绿
val ZenCream = Color(0xFFF0F3BD) // 奶油黄装饰
val ZenSurface = Color(0xFFFFFFFF)
val ZenBackgroundStart = Color(0xFFF1F5F9)
val ZenBackgroundEnd = Color(0xFFE2E8F0)

val TextPrimary = Color(0xFF1F2937)
val TextSecondary = Color(0xFF6B7280)

// 功能色
val ColorCorrect = Color(0xFF10B981)
val ColorWrong = Color(0xFFEF4444)
val ColorMistake = Color(0xFFF43F5E)
val ColorStar = Color(0xFFF59E0B)

// 渐变定义
val MainGradient = Brush.linearGradient(
    colors = listOf(ZenGreenPrimary, Color(0xFF1B4332)),
    start = Offset(0f, 0f),
    end = Offset(1000f, 1000f)
)

val CardGradient = Brush.verticalGradient(
    colors = listOf(Color.White, Color(0xFFF8FAFC))
)

val MistakeGradient = Brush.linearGradient(
    colors = listOf(Color(0xFFEF4444), Color(0xFFB91C1C))
)

// 炫彩文字渐变
val ColorfulGradient = Brush.linearGradient(
    colors = listOf(
        Color(0xFFEC4899), // Pink
        Color(0xFF8B5CF6), // Purple
        Color(0xFF3B82F6), // Blue
        Color(0xFF10B981)  // Green
    )
)

// 定义炫彩颜色数组 (用于流光特效)
val RainbowColors = listOf(
    Color(0xFFEC4899), // Pink
    Color(0xFF8B5CF6), // Purple
    Color(0xFF3B82F6), // Blue
    Color(0xFF06B6D4), // Cyan
    Color(0xFF10B981), // Green
    Color(0xFFFACC15), // Yellow
    Color(0xFFEC4899)  // Loop back to Pink
)
```

--- FILE: app\src\main\java\com\example\killquestion\ui\theme\Theme.kt ---
```kt
package com.example.killquestion.ui.theme

import android.app.Activity
import android.os.Build
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.darkColorScheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.material3.lightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.SideEffect
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.toArgb
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.platform.LocalView
import androidx.core.view.WindowCompat
import com.example.killquestion.data.local.FontManager

// 定义深色模式的配色方案
private val DarkColorScheme = darkColorScheme(
    primary = ZenGreenPrimary,
    secondary = ZenGreenAccent,
    tertiary = ZenCream,
    background = ZenDark,
    surface = ZenDark,
    onPrimary = Color.White,
    onSecondary = ZenDark,
    onTertiary = ZenDark,
    onBackground = Color.White,
    onSurface = Color.White,
)

// 定义浅色模式的配色方案
private val LightColorScheme = lightColorScheme(
    primary = ZenGreenPrimary,
    secondary = ZenGreenAccent,
    tertiary = ZenCream,
    background = ZenBackgroundStart,
    surface = ZenSurface,
    onPrimary = Color.White,
    onSecondary = Color.White,
    onTertiary = ZenDark,
    onBackground = TextPrimary,
    onSurface = TextPrimary,
)

@Composable
fun KillQuestionTheme(
    darkTheme: Boolean = isSystemInDarkTheme(),
    // Android 12+ 的动态取色功能 (Dynamic Color)
    dynamicColor: Boolean = true,
    content: @Composable () -> Unit
) {
    val colorScheme = when {
        dynamicColor && Build.VERSION.SDK_INT >= Build.VERSION_CODES.S -> {
            val context = LocalContext.current
            if (darkTheme) dynamicDarkColorScheme(context) else dynamicLightColorScheme(context)
        }
        darkTheme -> DarkColorScheme
        else -> LightColorScheme
    }

    val view = LocalView.current
    if (!view.isInEditMode) {
        SideEffect {
            val window = (view.context as Activity).window
            // 设置状态栏颜色
            window.statusBarColor = colorScheme.primary.toArgb()
            // 设置状态栏图标颜色 (浅色模式下图标为深色)
            WindowCompat.getInsetsController(window, view).isAppearanceLightStatusBars = !darkTheme
        }
    }

    MaterialTheme(
        colorScheme = colorScheme,
        typography = getAppTypography(FontManager.currentFontFamily), // 注意：如果报错 'Typography' 未找到，请看下面的说明
        content = content
    )
}
```

--- FILE: app\src\main\java\com\example\killquestion\ui\theme\Type.kt ---
```kt
package com.example.killquestion.ui.theme

import androidx.compose.material3.Typography
import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.sp

// 改为一个函数，根据传入的 fontFamily 生成 Typography
fun getAppTypography(fontFamily: FontFamily): Typography {
    return Typography(
        // 大标题
        displayMedium = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.Bold,
            fontSize = 45.sp,
            lineHeight = 52.sp,
            letterSpacing = 0.sp
        ),
        // 页面标题
        titleLarge = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.Bold,
            fontSize = 22.sp,
            lineHeight = 28.sp,
            letterSpacing = 0.sp
        ),
        // 普通标题
        titleMedium = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.SemiBold,
            fontSize = 16.sp,
            lineHeight = 24.sp,
            letterSpacing = 0.15.sp
        ),
        // 正文
        bodyLarge = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.Normal,
            fontSize = 16.sp,
            lineHeight = 24.sp,
            letterSpacing = 0.5.sp
        ),
        bodyMedium = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.Normal,
            fontSize = 14.sp,
            lineHeight = 20.sp,
            letterSpacing = 0.25.sp
        ),
        // 按钮文字
        labelLarge = TextStyle(
            fontFamily = fontFamily,
            fontWeight = FontWeight.Medium,
            fontSize = 14.sp,
            lineHeight = 20.sp,
            letterSpacing = 0.1.sp
        )
    )
}
```

--- FILE: app\src\main\java\com\example\killquestion\util\ChineseComparator.kt ---
```kt
package com.example.killquestion.util

class ChineseStringComparator : Comparator<String> {
    private val chineseNumberMap = mapOf(
        '一' to 1, '二' to 2, '三' to 3, '四' to 4, '五' to 5,
        '六' to 6, '七' to 7, '八' to 8, '九' to 9, '十' to 10,
        '零' to 0
    )

    override fun compare(s1: String?, s2: String?): Int {
        if (s1 == null || s2 == null) return 0
        val n1 = extractNumber(s1)
        val n2 = extractNumber(s2)
        if (n1 != -1 && n2 != -1) return n1.compareTo(n2)
        return s1.compareTo(s2)
    }

    private fun extractNumber(s: String): Int {
        val digitMatch = Regex("\\d+").find(s)
        if (digitMatch != null) return digitMatch.value.toInt()
        val cnMatch = Regex("[一二三四五六七八九十]+").find(s)
        if (cnMatch != null) return parseChineseNumber(cnMatch.value)
        return -1
    }

    private fun parseChineseNumber(s: String): Int {
        var result = 0
        var temp = 0
        for (char in s) {
            val value = chineseNumberMap[char] ?: continue
            if (value == 10) {
                if (temp == 0) temp = 1
                result += temp * 10
                temp = 0
            } else {
                temp = value
            }
        }
        result += temp
        return if (result == 0) -1 else result
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\util\ImageSaver.kt ---
```kt
package com.example.killquestion.utils

import android.content.ContentValues
import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.os.Build
import android.os.Environment
import android.provider.MediaStore
import android.widget.Toast
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext
import java.io.File
import java.io.FileOutputStream
import java.io.OutputStream
import java.net.URL

object ImageSaver {

    suspend fun saveImageToGallery(context: Context, imageUrl: String) {
        withContext(Dispatchers.IO) {
            try {
                // 1. 下载图片为 Bitmap
                val url = URL(imageUrl)
                val connection = url.openConnection()
                connection.connect()
                val inputStream = connection.getInputStream()
                val bitmap = BitmapFactory.decodeStream(inputStream)
                inputStream.close()

                if (bitmap == null) {
                    withContext(Dispatchers.Main) {
                        Toast.makeText(context, "下载失败：无法解析图片", Toast.LENGTH_SHORT).show()
                    }
                    return@withContext
                }

                // 2. 保存到相册
                saveBitmap(context, bitmap)

            } catch (e: Exception) {
                e.printStackTrace()
                withContext(Dispatchers.Main) {
                    Toast.makeText(context, "保存失败: ${e.localizedMessage}", Toast.LENGTH_SHORT).show()
                }
            }
        }
    }

    private suspend fun saveBitmap(context: Context, bitmap: Bitmap) {
        val filename = "AI_Art_${System.currentTimeMillis()}.jpg"
        var fos: OutputStream? = null
        var imageUri: android.net.Uri? = null

        try {
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
                // Android 10+ 使用 MediaStore
                val resolver = context.contentResolver
                val contentValues = ContentValues().apply {
                    put(MediaStore.MediaColumns.DISPLAY_NAME, filename)
                    put(MediaStore.MediaColumns.MIME_TYPE, "image/jpeg")
                    put(MediaStore.MediaColumns.RELATIVE_PATH, Environment.DIRECTORY_PICTURES + "/KillQuestion")
                }
                imageUri = resolver.insert(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, contentValues)
                fos = imageUri?.let { resolver.openOutputStream(it) }
            } else {
                // Android 9 及以下 (需要权限，这里简化处理，假设存私有目录或已授权)
                // 建议为了兼容性，只关注 Android 10+ 逻辑，或者提示用户
                val imagesDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES)
                val image = File(imagesDir, filename)
                fos = FileOutputStream(image)
            }

            fos?.use {
                bitmap.compress(Bitmap.CompressFormat.JPEG, 100, it)
                withContext(Dispatchers.Main) {
                    Toast.makeText(context, "已保存到相册！", Toast.LENGTH_SHORT).show()
                }
            }
        } catch (e: Exception) {
            e.printStackTrace()
            // 如果写入失败，清理 Uri
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q && imageUri != null) {
                context.contentResolver.delete(imageUri, null, null)
            }
            throw e
        }
    }
}
```

--- FILE: app\src\main\java\com\example\killquestion\util\PdfExportManager.kt ---
```kt
package com.example.killquestion.util

import android.content.Context
import android.content.Intent
import android.graphics.Canvas
import android.graphics.Color
import android.graphics.Paint
import android.graphics.RectF
import android.graphics.Typeface
import android.graphics.pdf.PdfDocument
import android.net.Uri
import android.text.Layout
import android.text.Spannable
import android.text.SpannableStringBuilder
import android.text.StaticLayout
import android.text.TextPaint
import android.text.style.StyleSpan
import androidx.core.content.FileProvider
import java.io.File
import java.io.FileOutputStream

object PdfExportManager {

    // 颜色定义 (RGB)
    private val COLOR_PRIMARY = Color.rgb(45, 106, 79) // 深绿
    private val COLOR_PRIMARY_LIGHT = Color.rgb(232, 245, 233) // 浅绿背景
    private val COLOR_TEXT_PRIMARY = Color.rgb(31, 41, 55) // 深灰字
    private val COLOR_BG_GRAY = Color.rgb(241, 245, 249) // 页面底色

    fun exportAndShare(context: Context, cards: List<Pair<String, String>>) {
        try {
            val file = generatePdf(context, cards)
            shareFile(context, file)
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }

    private fun generatePdf(context: Context, cards: List<Pair<String, String>>): File {
        val pdfDocument = PdfDocument()
        val pageWidth = 595 // A4 宽
        val pageHeight = 842 // A4 高

        // --- 画笔设置 ---
        // 1. 页面背景画笔
        val pageBgPaint = Paint().apply { color = COLOR_BG_GRAY; style = Paint.Style.FILL }

        // 2. 卡片背景画笔 (纯白 + 阴影模拟)
        val cardBgPaint = Paint().apply {
            color = Color.WHITE
            style = Paint.Style.FILL
            setShadowLayer(12f, 0f, 6f, Color.LTGRAY)
        }

        // 3. 标题栏背景画笔
        val headerBgPaint = Paint().apply { color = COLOR_PRIMARY_LIGHT }

        // 4. 序号圆圈画笔
        val indexBgPaint = Paint().apply { color = COLOR_PRIMARY; isAntiAlias = true }

        // 5. 序号文字
        val indexTextPaint = Paint().apply {
            color = Color.WHITE
            textSize = 20f
            typeface = Typeface.DEFAULT_BOLD
            textAlign = Paint.Align.CENTER
            isAntiAlias = true
        }

        // 6. 标题文字
        val titlePaint = TextPaint().apply {
            color = COLOR_PRIMARY
            textSize = 24f
            typeface = Typeface.create(Typeface.DEFAULT, Typeface.BOLD)
            isAntiAlias = true
        }

        // 7. 内容文字 (关键：支持 Spannable)
        val contentPaint = TextPaint().apply {
            color = COLOR_TEXT_PRIMARY
            textSize = 16f
            isAntiAlias = true
        }

        // 8. 署名文字
        val footerPaint = Paint().apply {
            color = Color.GRAY
            textSize = 12f
            textAlign = Paint.Align.CENTER
            isAntiAlias = true
        }

        val margin = 40f
        val cardWidth = pageWidth - margin * 2
        val cardHeight = pageHeight - margin * 2

        cards.forEachIndexed { index, (title, rawContent) ->
            val pageInfo = PdfDocument.PageInfo.Builder(pageWidth, pageHeight, index + 1).create()
            val page = pdfDocument.startPage(pageInfo)
            val canvas = page.canvas

            // 1. 填充页面淡灰底色 (提升质感)
            canvas.drawRect(0f, 0f, pageWidth.toFloat(), pageHeight.toFloat(), pageBgPaint)

            // 2. 绘制卡片大白底 (圆角)
            val cardRect = RectF(margin, margin, margin + cardWidth, margin + cardHeight)
            canvas.drawRoundRect(cardRect, 20f, 20f, cardBgPaint)

            // 3. 绘制标题栏 (卡片上部的淡绿色区域)
            // 技巧：先保存画布，裁剪出上半圆角
            canvas.save()
            canvas.clipRect(margin, margin, margin + cardWidth, margin + 100f)
            canvas.drawRoundRect(cardRect, 20f, 20f, headerBgPaint)
            canvas.restore()

            // 4. 绘制序号
            val circleX = margin + 40f
            val circleY = margin + 50f
            canvas.drawCircle(circleX, circleY, 18f, indexBgPaint)
            val fontMetrics = indexTextPaint.fontMetrics
            val baseline = (fontMetrics.descent - fontMetrics.ascent) / 2 - fontMetrics.descent
            canvas.drawText("${index + 1}", circleX, circleY + baseline, indexTextPaint)

            // 5. 绘制标题 (自动换行)
            val titleLayout = StaticLayout.Builder.obtain(title, 0, title.length, titlePaint, (cardWidth - 100).toInt())
                .setAlignment(Layout.Alignment.ALIGN_NORMAL)
                .build()
            canvas.save()
            canvas.translate(margin + 80f, margin + 35f) // 标题位置
            titleLayout.draw(canvas)
            canvas.restore()

            // 6. 绘制分割线
            val dividerY = margin + 100f
            val dividerPaint = Paint().apply { color = Color.rgb(230, 230, 230); strokeWidth = 2f }
            canvas.drawLine(margin, dividerY, margin + cardWidth, dividerY, dividerPaint)

            // 7. 处理并绘制内容 (支持粗体！)
            // 将 Markdown 转换为 Android 的 SpannableString
            val styledContent = parseMarkdownToSpannable(rawContent)

            val contentLayout = StaticLayout.Builder.obtain(styledContent, 0, styledContent.length, contentPaint, (cardWidth - 60).toInt())
                .setAlignment(Layout.Alignment.ALIGN_NORMAL)
                .setLineSpacing(10f, 1f) // 增加行间距
                .build()

            canvas.save()
            canvas.translate(margin + 30f, dividerY + 30f) // 内容起始位置
            contentLayout.draw(canvas)
            canvas.restore()

            // 8. 绘制底部装饰条
            val bottomBarHeight = 10f
            canvas.save()
            canvas.clipRect(margin, margin + cardHeight - bottomBarHeight, margin + cardWidth, margin + cardHeight)
            val bottomPaint = Paint().apply { color = COLOR_PRIMARY }
            canvas.drawRoundRect(cardRect, 20f, 20f, bottomPaint)
            canvas.restore()

            // 9. 署名 (页面最下方)
            canvas.drawText("- Designed by 邝梓濠 -", pageWidth / 2f, pageHeight - 15f, footerPaint)

            pdfDocument.finishPage(page)
        }

        val dir = File(context.cacheDir, "pdfs").apply { mkdirs() }
        val file = File(dir, "智能弱点分析卡片_${System.currentTimeMillis()}.pdf")
        pdfDocument.writeTo(FileOutputStream(file))
        pdfDocument.close()

        return file
    }

    // [核心辅助方法]：解析 Markdown (**text**) 为 SpannableString (Bold style)
    private fun parseMarkdownToSpannable(text: String): CharSequence {
        // 1. 处理列表符号，把 "- " 变成 "• "
        var processedText = text.replace(Regex("^[-*]\\s+"), "• ") // 替换开头的
        processedText = processedText.replace(Regex("\n[-*]\\s+"), "\n• ") // 替换换行后的

        // 2. 移除标题符号 #
        processedText = processedText.replace("#", "")

        val builder = SpannableStringBuilder()

        // 正则匹配 **bold**
        val boldRegex = Regex("\\*\\*(.*?)\\*\\*")
        var lastIndex = 0

        boldRegex.findAll(processedText).forEach { matchResult ->
            // 添加普通文本
            builder.append(processedText.substring(lastIndex, matchResult.range.first))

            // 添加粗体文本
            val boldText = matchResult.groupValues[1]
            val start = builder.length
            builder.append(boldText)
            val end = builder.length

            // 设置粗体样式
            builder.setSpan(StyleSpan(Typeface.BOLD), start, end, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE)

            lastIndex = matchResult.range.last + 1
        }

        // 添加剩余文本
        if (lastIndex < processedText.length) {
            builder.append(processedText.substring(lastIndex))
        }

        return builder
    }

    private fun shareFile(context: Context, file: File) {
        val uri: Uri = FileProvider.getUriForFile(context, "${context.packageName}.fileprovider", file)
        val intent = Intent(Intent.ACTION_SEND).apply {
            type = "application/pdf"
            putExtra(Intent.EXTRA_STREAM, uri)
            addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
        }
        val chooser = Intent.createChooser(intent, "分享学习卡片")
        chooser.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        context.startActivity(chooser)
    }
}
```
